/*
SMSDynaRec - An attempt to implement a dynamic recompiling emulator for SMS/GG ROMs
Copyright (C) 2013 G. Cedric Marty (https://github.com/gmarty)
Based on JavaGear Copyright (c) 2002-2008 Chris White

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
'use strict';var DEBUG=!1,ACCURATE=!1,LITTLE_ENDIAN=!0,SUPPORT_DATAVIEW=!(!window.DataView||!window.ArrayBuffer),SAMPLE_RATE=44100,Setup={DEBUG_TIMING:DEBUG,REFRESH_EMULATION:!1,ACCURATE_INTERRUPT_EMULATION:ACCURATE,LIGHTGUN:!1,VDP_SPRITE_COLLISIONS:ACCURATE,PAGE_SIZE:1024};var frameTime=17,fpsInterval=500,CLOCK_NTSC=3579545,CLOCK_PAL=3546893;function JSSMS(a){this.opts={ui:JSSMS.DummyUI,swfPath:"lib/"};if(void 0!=a)for(var b in this.opts)void 0!=a[b]&&(this.opts[b]=a[b]);this.keyboard=new JSSMS.Keyboard(this);this.ui=new a.ui(this);this.vdp=new JSSMS.Vdp(this);this.psg=new JSSMS.SN76489(this);this.ports=new JSSMS.Ports(this);this.cpu=new JSSMS.Z80(this);this.ui.updateStatus("Ready to load a ROM.")}
JSSMS.prototype={isRunning:!1,cyclesPerLine:0,no_of_scanlines:0,frameSkip:0,throttle:!0,fps:0,frameskip_counter:0,pause_button:!1,is_sms:!0,is_gg:!1,soundEnabled:!0,audioBuffer:[],audioBufferOffset:0,samplesPerFrame:0,samplesPerLine:[],emuWidth:0,emuHeight:0,fpsFrameCount:0,z80Time:0,drawTime:0,z80TimeCounter:0,drawTimeCounter:0,frameCount:0,romData:"",romFileName:"",reset:function(){this.setVideoTiming(this.vdp.videoMode);this.frameCount=0;this.frameskip_counter=this.frameSkip;this.keyboard.reset();
this.ui.reset();this.vdp.reset();this.ports.reset();this.cpu.reset();this.cpu.resetMemory(null)},start:function(){var a=this;this.isRunning||(this.isRunning=!0);this.ui.requestAnimationFrame(this.frame.bind(this),this.ui.screen);this.resetFps();this.printFps();this.fpsInterval=setInterval(function(){a.printFps()},fpsInterval)},stop:function(){clearInterval(this.fpsInterval);this.isRunning=!1},frame:function(){this.isRunning&&(this.emulateNextFrame()&&this.doRepaint(),this.fpsFrameCount++,this.ui.requestAnimationFrame(this.frame.bind(this),
this.ui.screen))},emulateNextFrame:function(){for(var a=0,b=0;b<this.no_of_scanlines;b++)Setup.DEBUG_TIMING&&(a=JSSMS.Utils.getTimestamp()),Setup.ACCURATE_INTERRUPT_EMULATION&&193==b?(this.cpu.run(this.cyclesPerLine,8),this.vdp.setVBlankFlag(),this.cpu.run(0,0)):this.cpu.run(this.cyclesPerLine,0),Setup.DEBUG_TIMING&&(this.z80TimeCounter+=JSSMS.Utils.getTimestamp()-a),this.soundEnabled&&this.updateSound(b),this.vdp.line=b,0==this.frameskip_counter&&192>b&&(Setup.DEBUG_TIMING&&(a=JSSMS.Utils.getTimestamp()),
this.vdp.drawLine(b),Setup.DEBUG_TIMING&&(this.drawTimeCounter+=JSSMS.Utils.getTimestamp()-a)),this.vdp.interrupts(b);this.soundEnabled&&this.audioOutput(this.audioBuffer);Setup.DEBUG_TIMING&&60==++this.frameCount&&(this.z80Time=this.z80TimeCounter,this.drawTime=this.drawTimeCounter,this.frameCount=this.drawTimeCounter=this.z80TimeCounter=0);this.pause_button&&(this.cpu.nmi(),this.pause_button=!1);return 0==this.frameskip_counter--?(this.frameskip_counter=this.frameSkip,!0):!1},setSMS:function(){this.is_sms=
!0;this.is_gg=!1;this.vdp.h_start=0;this.vdp.h_end=32;this.emuWidth=SMS_WIDTH;this.emuHeight=SMS_HEIGHT},setGG:function(){this.is_gg=!0;this.is_sms=!1;this.vdp.h_start=5;this.vdp.h_end=27;this.emuWidth=GG_WIDTH;this.emuHeight=GG_HEIGHT},setVideoTiming:function(a){var b=0;a==NTSC||this.is_gg?(this.fps=60,this.no_of_scanlines=SMS_Y_PIXELS_NTSC,b=CLOCK_NTSC):a==PAL&&(this.fps=50,this.no_of_scanlines=SMS_Y_PIXELS_PAL,b=CLOCK_PAL);this.cyclesPerLine=Math.round(b/this.fps/this.no_of_scanlines+1);this.vdp.videoMode=
a;if(this.soundEnabled){this.psg.init(b,SAMPLE_RATE);this.samplesPerFrame=Math.round(SAMPLE_RATE/this.fps);if(0==this.audioBuffer.length||this.audioBuffer.length!=this.samplesPerFrame)this.audioBuffer=Array(this.samplesPerFrame);if(0==this.samplesPerLine.length||this.samplesPerLine.length!=this.no_of_scanlines){this.samplesPerLine=Array(this.no_of_scanlines);var c=0;for(a=0;a<this.no_of_scanlines;a++)b=(this.samplesPerFrame<<16)/this.no_of_scanlines+c,c=b-(b>>16<<16),this.samplesPerLine[a]=b>>16}}},
audioOutput:function(a){this.ui.writeAudio(a)},doRepaint:function(){this.ui.writeFrame(this.vdp.display,[])},printFps:function(){var a=JSSMS.Utils.getTimestamp(),b="Running";this.lastFpsTime&&(b+=": "+(this.fpsFrameCount/((a-this.lastFpsTime)/1E3)).toFixed(2)+" (/ "+(1E3/frameTime).toFixed(2)+") FPS");this.ui.updateStatus(b);this.fpsFrameCount=0;this.lastFpsTime=a},resetFps:function(){this.lastFpsTime=null;this.fpsFrameCount=0},updateSound:function(a){0==a&&(this.audioBufferOffset=0);a=this.samplesPerLine[a];
this.audioBuffer=this.psg.update(this.audioBufferOffset,a);this.audioBufferOffset+=a},readRomDirectly:function(a,b){var c;c=".gg"==b.substr(-3).toLowerCase()?2:1;var d=a.length;1==c?this.setSMS():2==c&&this.setGG();if(d<=Setup.PAGE_SIZE)return!1;c=this.loadROM(a,d);if(null==c)return!1;this.cpu.resetMemory(c);this.romData=a;this.romFileName=b;return!0},loadROM:function(a,b){0!=b%1024&&(a=a.substr(512),b-=512);var c,d,e=Math.round(b/Setup.PAGE_SIZE),f=Array(e);for(c=0;c<e;c++)if(f[c]=JSSMS.Utils.Array(Setup.PAGE_SIZE),
SUPPORT_DATAVIEW)for(d=0;d<Setup.PAGE_SIZE;d++)f[c].setUint8(d,a.charCodeAt(c*Setup.PAGE_SIZE+d));else for(d=0;d<Setup.PAGE_SIZE;d++)f[c][d]=a.charCodeAt(c*Setup.PAGE_SIZE+d)&255;return f},reloadRom:function(){return""!=this.romData&&""!=this.romFileName?this.readRomDirectly(this.romData,this.romFileName):!1}};JSSMS.Utils={rndInt:function(a){return Math.round(Math.random()*a)},Array:function(){return SUPPORT_DATAVIEW?function(a){a||(a=0);return new DataView(new ArrayBuffer(a))}:Array}(),copyArrayElements:function(){return SUPPORT_DATAVIEW?function(a,b,c,d,e){for(;e--;)c.setInt8(d+e,a.getInt8(b+e))}:function(a,b,c,d,e){for(;e--;)c[d+e]=a[b+e]}}(),copyArray:function(){return SUPPORT_DATAVIEW?function(a){if(!a)return JSSMS.Utils.Array();var b,c;b=a.byteLength;for(c=new JSSMS.Utils.Array(b);b--;)c.setInt8(b,
a.getInt8(b));return c}:function(a){if(!a)return JSSMS.Utils.Array();var b,c;b=a.length;for(c=new JSSMS.Utils.Array(b);b--;)void 0!=a[b]&&(c[b]=a[b]);return c}}(),writeMem:function(){return SUPPORT_DATAVIEW?function(a,b,c){if(DEBUG&&(b>>10>=a.memWriteMap.length||!a.memWriteMap[b>>10]||(b&1023)>=a.memWriteMap[b>>10].byteLength)){console.error(b,b>>10,b&1023);debugger}a.memWriteMap[b>>10].setInt8(b&1023,c);65532<=b&&a.page(b&3,c)}:function(a,b,c){a.memWriteMap[b>>10][b&1023]=c;65532<=b&&a.page(b&3,
c)}}(),readMem:function(){return SUPPORT_DATAVIEW?function(a,b){if(DEBUG&&(b>>10>=a.length||!a[b>>10]||(b&1023)>=a[b>>10].byteLength)){console.error(b,b>>10,b&1023);debugger}return a[b>>10].getUint8(b&1023)}:function(a,b){return a[b>>10][b&1023]&255}}(),readMemWord:function(){return SUPPORT_DATAVIEW?function(a,b){if(DEBUG&&(b>>10>=a.length||!a[b>>10]||(b&1023)>=a[b>>10].byteLength)){console.error(b,b>>10,b&1023);debugger}return 1023>(b&1023)?a[b>>10].getUint16(b&1023,LITTLE_ENDIAN):a[b>>10].getUint8(b&
1023)|a[++b>>10].getUint8(b&1023)<<8}:function(a,b){return a[b>>10][b&1023]&255|(a[++b>>10][b&1023]&255)<<8}}(),getTimestamp:Date.now||function(){return(new Date).getTime()},getPrefix:function(a,b){var c=!1;void 0==b&&(b=document);a.some(function(a){return a in b?(c=a,!0):!1});return c},isIE:function(){return/msie/i.test(navigator.userAgent)&&!/opera/i.test(navigator.userAgent)}};var ENABLE_DYNAREC=!0,HOT_BLOCK_THRESHOLD=1,JPinst=[194,195,202,210,218,226,233,234,242,250],JRinst=[16,24,32,40,48,56],CALLinst=[196,204,205,212,220,228,236,244,252],RETinst=[192,200,201,208,216,224,232,240,248],DIinst=[243],miscInst=[221,253,237,118],endingInst=[].concat(JPinst,JRinst,CALLinst,RETinst,DIinst,miscInst),emptyInst=[0,64,73,82,91,100,109,127],isEndingInst=function(a){return 0<=endingInst.indexOf(a)},isEmptyInst=function(a){return 0<=emptyInst.indexOf(a)},toHex=function(a){a=a.toString(16);
1==a.length&&(a="0"+a);return"0x"+a},buildOpcodeInsts=function(){for(var a=0,b=Array(255);255>=a;a++)b[a]=getOpCodeInst(a);return b},getOpCodeInst=function(a){var b=[],c="",c=OP_STATES[a];b.push("/* opcode: "+toHex(a)+"*/");Setup.ACCURATE_INTERRUPT_EMULATION&&b.push("if (this.interruptLine)\n  this.interrupt();                  /* Check for interrupt */");b.push("this.pc++;");Setup.ACCURATE_INTERRUPT_EMULATION&&b.push("this.EI_inst = false;");0<c&&b.push("this.tstates -= "+c+";   /* Decrement TStates */");
Setup.REFRESH_EMULATION&&b.push("this.incR();");c=opcodeToJS(a).replace(/"use strict";/,"").replace(/function \(\) ?{/,"").replace(/}$/,"").trim().replace(/\r?\n|\r/g,"\n").replace(/^\s+/gm,"");return(b.join("\n")+"\n"+c).trim()+";\n"+"".trim()},opcodeToJS=function(a){var b;b=HALT_SPEEDUP?function(){this.tstates=0;this.halt=!0;this.pc--}:function(){this.halt=!0;this.pc--};return{"0":function(){},1:function(){this.c=this.readMem(this.pc++);this.b=this.readMem(this.pc++)},2:function(){this.writeMem(this.b<<
8|this.c,this.a)},3:function(){this.c=this.c+1&255;0==this.c&&(this.b=this.b+1&255)},4:function(){this.b=this.b+1&255;this.f=this.f&F_CARRY|this.SZHV_INC_TABLE[this.b]},5:function(){this.b=this.b-1&255;this.f=this.f&F_CARRY|this.SZHV_DEC_TABLE[this.b]},6:function(){this.b=this.readMem(this.pc++)},7:function(){var a=this.a>>7;this.a=this.a<<1&255|a;this.f=this.f&236|a},8:function(){var a=this.a;this.a=this.a2;this.a2=a;a=this.f;this.f=this.f2;this.f2=a},9:function(){var a=this.h<<8|this.l,b=this.b<<
8|this.c,e=a+b;this.f=this.f&196|(a^e^b)>>8&16|e>>16&1;a=e&65535;this.h=a>>8;this.l=a&255},10:function(){this.a=this.readMem(this.b<<8|this.c)},11:function(){this.c=this.c-1&255;255==this.c&&(this.b=this.b-1&255)},12:function(){this.c=this.c+1&255;this.f=this.f&F_CARRY|this.SZHV_INC_TABLE[this.c]},13:function(){this.c=this.c-1&255;this.f=this.f&F_CARRY|this.SZHV_DEC_TABLE[this.c]},14:function(){this.c=this.readMem(this.pc++)},15:function(){var a=this.a&1;this.a=this.a>>1|a<<7;this.f=this.f&236|a},
16:function(){this.b=this.b-1&255;if(0!=this.b){var a=this.d_()+1;128<=a&&(a-=256);this.pc+=a;this.tstates-=5}else this.pc++},17:function(){this.e=this.readMem(this.pc++);this.d=this.readMem(this.pc++)},18:function(){this.writeMem(this.d<<8|this.e,this.a)},19:function(){this.e=this.e+1&255;0==this.e&&(this.d=this.d+1&255)},20:function(){this.d=this.d+1&255;this.f=this.f&F_CARRY|this.SZHV_INC_TABLE[this.d]},21:function(){this.d=this.d-1&255;this.f=this.f&F_CARRY|this.SZHV_DEC_TABLE[this.d]},22:function(){this.d=
this.readMem(this.pc++)},23:function(){var a=this.a>>7;this.a=(this.a<<1|this.f&F_CARRY)&255;this.f=this.f&236|a},24:function(){this.pc+=this.readMem(this.pc)+1},25:function(){var a=(this.h<<8|this.l)+(this.d<<8|this.e);this.f=this.f&196|((this.h<<8|this.l)^a^(this.d<<8|this.e))>>8&16|a>>16&1;this.h=(a&65535)>>8;this.l=a&255},26:function(){this.a=this.readMem(this.d<<8|this.e)},27:function(){this.e=this.e-1&255;255==this.e&&(this.d=this.d-1&255)},28:function(){this.e=this.e+1&255;this.f=this.f&F_CARRY|
this.SZHV_INC_TABLE[this.e]},29:function(){this.e=this.e-1&255;this.f=this.f&F_CARRY|this.SZHV_DEC_TABLE[this.e]},30:function(){this.e=this.readMem(this.pc++)},31:function(){var a=this.a&1;this.a=(this.a>>1|(this.f&F_CARRY)<<7)&255;this.f=this.f&236|a},32:function(){if(0==(this.f&F_ZERO)){var a=this.d_()+1;128<=a&&(a-=256);this.pc+=a;this.tstates-=5}else this.pc++},33:function(){this.l=this.readMem(this.pc++);this.h=this.readMem(this.pc++)},34:function(){var a=this.readMemWord(this.pc);this.writeMem(a,
this.l);this.writeMem(++a,this.h);this.pc+=2},35:function(){this.l=this.l+1&255;0==this.l&&(this.h=this.h+1&255)},36:function(){this.h=this.h+1&255;this.f=this.f&F_CARRY|this.SZHV_INC_TABLE[this.h]},37:function(){this.h=this.h-1&255;this.f=this.f&F_CARRY|this.SZHV_DEC_TABLE[this.h]},38:function(){this.h=this.readMem(this.pc++)},39:function(){var a=this.DAA_TABLE[this.a|(this.f&F_CARRY)<<8|(this.f&F_NEGATIVE)<<8|(this.f&F_HALFCARRY)<<6];this.a=a&255;this.f=this.f&F_NEGATIVE|a>>8},40:function(){if(0!=
(this.f&F_ZERO)){var a=this.d_()+1;128<=a&&(a-=256);this.pc+=a;this.tstates-=5}else this.pc++},41:function(){var a=(this.h<<8|this.l)+(this.h<<8|this.l);this.f=this.f&196|((this.h<<8|this.l)^a^(this.h<<8|this.l))>>8&16|a>>16&1;this.h=(a&65535)>>8;this.l=a&255},42:function(){var a=this.readMemWord(this.pc);this.l=this.readMem(a);this.h=this.readMem(a+1);this.pc+=2},43:function(){this.l=this.l-1&255;255==this.l&&(this.h=this.h-1&255)},44:function(){this.l=this.l+1&255;this.f=this.f&F_CARRY|this.SZHV_INC_TABLE[this.l]},
45:function(){this.l=this.l-1&255;this.f=this.f&F_CARRY|this.SZHV_DEC_TABLE[this.l]},46:function(){this.l=this.readMem(this.pc++)},47:function(){this.a^=255;this.f|=F_NEGATIVE|F_HALFCARRY},48:function(){if(0==(this.f&F_CARRY)){var a=this.d_()+1;128<=a&&(a-=256);this.pc+=a;this.tstates-=5}else this.pc++},49:function(){this.sp=this.readMemWord(this.pc);this.pc+=2},50:function(){this.writeMem(this.readMemWord(this.pc),this.a);this.pc+=2},51:function(){this.sp++},52:function(){this.writeMem(this.h<<8|
this.l,this.inc8(this.readMem(this.h<<8|this.l)))},53:function(){var a=this.h<<8|this.l,b=this.readMem(a),b=b-1&255;this.f=this.f&F_CARRY|this.SZHV_DEC_TABLE[b];this.writeMem(a,b)},54:function(){this.writeMem(this.h<<8|this.l,this.readMem(this.pc++))},55:function(){this.f|=F_CARRY;this.f&=~F_NEGATIVE;this.f&=~F_HALFCARRY},56:function(){if(0!=(this.f&F_CARRY)){var a=this.d_()+1;128<=a&&(a-=256);this.pc+=a;this.tstates-=5}else this.pc++},57:function(){var a=(this.h<<8|this.l)+this.sp;this.f=this.f&
196|((this.h<<8|this.l)^a^this.sp)>>8&16|a>>16&1;this.h=(a&65535)>>8;this.l=a&255},58:function(){this.a=this.readMem(this.readMemWord(this.pc));this.pc+=2},59:function(){this.sp--},60:function(){this.a=this.a+1&255;this.f=this.f&F_CARRY|this.SZHV_INC_TABLE[this.a]},61:function(){this.a=this.a-1&255;this.f=this.f&F_CARRY|this.SZHV_DEC_TABLE[this.a]},62:function(){this.a=this.readMem(this.pc++)},63:function(){0!=(this.f&F_CARRY)?(this.f&=~F_CARRY,this.f|=F_HALFCARRY):(this.f|=F_CARRY,this.f&=~F_HALFCARRY);
this.f&=~F_NEGATIVE},64:function(){},65:function(){this.b=this.c},66:function(){this.b=this.d},67:function(){this.b=this.e},68:function(){this.b=this.h},69:function(){this.b=this.l},70:function(){this.b=this.readMem(this.h<<8|this.l)},71:function(){this.b=this.a},72:function(){this.c=this.b},73:function(){},74:function(){this.c=this.d},75:function(){this.c=this.e},76:function(){this.c=this.h},77:function(){this.c=this.l},78:function(){this.c=this.readMem(this.h<<8|this.l)},79:function(){this.c=this.a},
80:function(){this.d=this.b},81:function(){this.d=this.c},82:function(){},83:function(){this.d=this.e},84:function(){this.d=this.h},85:function(){this.d=this.l},86:function(){this.d=this.readMem(this.h<<8|this.l)},87:function(){this.d=this.a},88:function(){this.e=this.b},89:function(){this.e=this.c},90:function(){this.e=this.d},91:function(){},92:function(){this.e=this.h},93:function(){this.e=this.l},94:function(){this.e=this.readMem(this.h<<8|this.l)},95:function(){this.e=this.a},96:function(){this.h=
this.b},97:function(){this.h=this.c},98:function(){this.h=this.d},99:function(){this.h=this.e},100:function(){},101:function(){this.h=this.l},102:function(){this.h=this.readMem(this.h<<8|this.l)},103:function(){this.h=this.a},104:function(){this.l=this.b},105:function(){this.l=this.c},106:function(){this.l=this.d},107:function(){this.l=this.e},108:function(){this.l=this.h},109:function(){},110:function(){this.l=this.readMem(this.h<<8|this.l)},111:function(){this.l=this.a},112:function(){this.writeMem(this.h<<
8|this.l,this.b)},113:function(){this.writeMem(this.h<<8|this.l,this.c)},114:function(){this.writeMem(this.h<<8|this.l,this.d)},115:function(){this.writeMem(this.h<<8|this.l,this.e)},116:function(){this.writeMem(this.h<<8|this.l,this.h)},117:function(){this.writeMem(this.h<<8|this.l,this.l)},118:b,119:function(){this.writeMem(this.h<<8|this.l,this.a)},120:function(){this.a=this.b},121:function(){this.a=this.c},122:function(){this.a=this.d},123:function(){this.a=this.e},124:function(){this.a=this.h},
125:function(){this.a=this.l},126:function(){this.a=this.readMem(this.h<<8|this.l)},127:function(){},128:function(){var a=this.a+this.b&255;this.f=this.SZHVC_ADD_TABLE[this.a<<8|a];this.a=a},129:function(){var a=this.a+this.c&255;this.f=this.SZHVC_ADD_TABLE[this.a<<8|a];this.a=a},130:function(){var a=this.a+this.d&255;this.f=this.SZHVC_ADD_TABLE[this.a<<8|a];this.a=a},131:function(){var a=this.a+this.e&255;this.f=this.SZHVC_ADD_TABLE[this.a<<8|a];this.a=a},132:function(){var a=this.a+this.h&255;this.f=
this.SZHVC_ADD_TABLE[this.a<<8|a];this.a=a},133:function(){var a=this.a+this.l&255;this.f=this.SZHVC_ADD_TABLE[this.a<<8|a];this.a=a},134:function(){var a=this.a+this.readMem(this.h<<8|this.l)&255;this.f=this.SZHVC_ADD_TABLE[this.a<<8|a];this.a=a},135:function(){var a=this.a+this.a&255;this.f=this.SZHVC_ADD_TABLE[this.a<<8|a];this.a=a},136:function(){var a=this.f&F_CARRY,b=this.a+this.b+a&255;this.f=this.SZHVC_ADD_TABLE[a<<16|this.a<<8|b];this.a=b},137:function(){var a=this.f&F_CARRY,b=this.a+this.c+
a&255;this.f=this.SZHVC_ADD_TABLE[a<<16|this.a<<8|b];this.a=b},138:function(){var a=this.f&F_CARRY,b=this.a+this.d+a&255;this.f=this.SZHVC_ADD_TABLE[a<<16|this.a<<8|b];this.a=b},139:function(){var a=this.f&F_CARRY,b=this.a+this.e+a&255;this.f=this.SZHVC_ADD_TABLE[a<<16|this.a<<8|b];this.a=b},140:function(){var a=this.f&F_CARRY,b=this.a+this.h+a&255;this.f=this.SZHVC_ADD_TABLE[a<<16|this.a<<8|b];this.a=b},141:function(){var a=this.f&F_CARRY,b=this.a+this.l+a&255;this.f=this.SZHVC_ADD_TABLE[a<<16|this.a<<
8|b];this.a=b},142:function(){var a=this.f&F_CARRY,b=this.a+this.readMem(this.h<<8|this.l)+a&255;this.f=this.SZHVC_ADD_TABLE[a<<16|this.a<<8|b];this.a=b},143:function(){var a=this.f&F_CARRY,b=this.a+this.a+a&255;this.f=this.SZHVC_ADD_TABLE[a<<16|this.a<<8|b];this.a=b},144:function(){var a=this.a-this.b&255;this.f=this.SZHVC_SUB_TABLE[this.a<<8|a];this.a=a},145:function(){var a=this.a-this.c&255;this.f=this.SZHVC_SUB_TABLE[this.a<<8|a];this.a=a},146:function(){var a=this.a-this.d&255;this.f=this.SZHVC_SUB_TABLE[this.a<<
8|a];this.a=a},147:function(){var a=this.a-this.e&255;this.f=this.SZHVC_SUB_TABLE[this.a<<8|a];this.a=a},148:function(){var a=this.a-this.h&255;this.f=this.SZHVC_SUB_TABLE[this.a<<8|a];this.a=a},149:function(){var a=this.a-this.l&255;this.f=this.SZHVC_SUB_TABLE[this.a<<8|a];this.a=a},150:function(){var a=this.a-this.readMem(this.h<<8|this.l)&255;this.f=this.SZHVC_SUB_TABLE[this.a<<8|a];this.a=a},151:function(){var a=this.a-this.a&255;this.f=this.SZHVC_SUB_TABLE[this.a<<8|a];this.a=a},152:function(){var a=
this.f&F_CARRY,b=this.a-this.b-a&255;this.f=this.SZHVC_SUB_TABLE[a<<16|this.a<<8|b];this.a=b},153:function(){var a=this.f&F_CARRY,b=this.a-this.c-a&255;this.f=this.SZHVC_SUB_TABLE[a<<16|this.a<<8|b];this.a=b},154:function(){var a=this.f&F_CARRY,b=this.a-this.d-a&255;this.f=this.SZHVC_SUB_TABLE[a<<16|this.a<<8|b];this.a=b},155:function(){var a=this.f&F_CARRY,b=this.a-this.e-a&255;this.f=this.SZHVC_SUB_TABLE[a<<16|this.a<<8|b];this.a=b},156:function(){var a=this.f&F_CARRY,b=this.a-this.h-a&255;this.f=
this.SZHVC_SUB_TABLE[a<<16|this.a<<8|b];this.a=b},157:function(){var a=this.f&F_CARRY,b=this.a-this.l-a&255;this.f=this.SZHVC_SUB_TABLE[a<<16|this.a<<8|b];this.a=b},158:function(){var a=this.f&F_CARRY,b=this.a-this.readMem(this.h<<8|this.l)-a&255;this.f=this.SZHVC_SUB_TABLE[a<<16|this.a<<8|b];this.a=b},159:function(){var a=this.f&F_CARRY,b=this.a-this.a-a&255;this.f=this.SZHVC_SUB_TABLE[a<<16|this.a<<8|b];this.a=b},160:function(){this.f=this.SZP_TABLE[this.a&=this.b]|F_HALFCARRY},161:function(){this.f=
this.SZP_TABLE[this.a&=this.c]|F_HALFCARRY},162:function(){this.f=this.SZP_TABLE[this.a&=this.d]|F_HALFCARRY},163:function(){this.f=this.SZP_TABLE[this.a&=this.e]|F_HALFCARRY},164:function(){this.f=this.SZP_TABLE[this.a&=this.h]|F_HALFCARRY},165:function(){this.f=this.SZP_TABLE[this.a&=this.l]|F_HALFCARRY},166:function(){this.f=this.SZP_TABLE[this.a&=this.readMem(this.h<<8|this.l)]|F_HALFCARRY},167:function(){this.f=this.SZP_TABLE[this.a]|F_HALFCARRY},168:function(){this.f=this.SZP_TABLE[this.a^=
this.b]},169:function(){this.f=this.SZP_TABLE[this.a^=this.c]},170:function(){this.f=this.SZP_TABLE[this.a^=this.d]},171:function(){this.f=this.SZP_TABLE[this.a^=this.e]},172:function(){this.f=this.SZP_TABLE[this.a^=this.h]},173:function(){this.f=this.SZP_TABLE[this.a^=this.l]},174:function(){this.f=this.SZP_TABLE[this.a^=this.readMem(this.h<<8|this.l)]},175:function(){this.f=this.SZP_TABLE[this.a=0]},176:function(){this.f=this.SZP_TABLE[this.a|=this.b]},177:function(){this.f=this.SZP_TABLE[this.a|=
this.c]},178:function(){this.f=this.SZP_TABLE[this.a|=this.d]},179:function(){this.f=this.SZP_TABLE[this.a|=this.e]},180:function(){this.f=this.SZP_TABLE[this.a|=this.h]},181:function(){this.f=this.SZP_TABLE[this.a|=this.l]},182:function(){this.f=this.SZP_TABLE[this.a|=this.readMem(this.h<<8|this.l)]},183:function(){this.f=this.SZP_TABLE[this.a]},184:function(){this.f=this.SZHVC_SUB_TABLE[this.a<<8|this.a-this.b&255]},185:function(){this.f=this.SZHVC_SUB_TABLE[this.a<<8|this.a-this.c&255]},186:function(){this.f=
this.SZHVC_SUB_TABLE[this.a<<8|this.a-this.d&255]},187:function(){this.f=this.SZHVC_SUB_TABLE[this.a<<8|this.a-this.e&255]},188:function(){this.f=this.SZHVC_SUB_TABLE[this.a<<8|this.a-this.h&255]},189:function(){this.f=this.SZHVC_SUB_TABLE[this.a<<8|this.a-this.l&255]},190:function(){this.f=this.SZHVC_SUB_TABLE[this.a<<8|this.a-this.readMem(this.h<<8|this.l)&255]},191:function(){this.f=this.SZHVC_SUB_TABLE[this.a<<8|this.a-this.a&255]},192:function(){0==(this.f&F_ZERO)&&(this.pc=this.readMemWord(this.sp),
this.sp+=2,this.tstates-=6)},193:function(){this.setBC(this.readMemWord(this.sp));this.sp+=2},194:function(){this.pc=0==(this.f&F_ZERO)?this.readMemWord(this.pc):this.pc+2},195:function(){this.pc=this.readMemWord(this.pc)},196:function(){0==(this.f&F_ZERO)?(this.writeMem(--this.sp,this.pc+2>>8),this.writeMem(--this.sp,this.pc+2&255),this.pc=this.readMemWord(this.pc),this.tstates-=7):this.pc+=2},197:function(){this.writeMem(--this.sp,this.b);this.writeMem(--this.sp,this.c)},198:function(){var a=this.a+
this.readMem(this.pc++)&255;this.f=this.SZHVC_ADD_TABLE[this.a<<8|a];this.a=a},199:function(){this.writeMem(--this.sp,this.pc>>8);this.writeMem(--this.sp,this.pc&255);this.pc=0},200:function(){0!=(this.f&F_ZERO)&&(this.pc=this.readMemWord(this.sp),this.sp+=2,this.tstates-=6)},201:function(){this.pc=this.readMemWord(this.sp);this.sp+=2},202:function(){this.pc=0!=(this.f&F_ZERO)?this.readMemWord(this.pc):this.pc+2},203:function(){this.doCB(this.readMem(this.pc++))},204:function(){0!=(this.f&F_ZERO)?
(this.writeMem(--this.sp,this.pc+2>>8),this.writeMem(--this.sp,this.pc+2&255),this.pc=this.readMemWord(this.pc),this.tstates-=7):this.pc+=2},205:function(){this.writeMem(--this.sp,this.pc+2>>8);this.writeMem(--this.sp,this.pc+2&255);this.pc=this.readMemWord(this.pc)},206:function(){var a=this.f&F_CARRY,b=this.a+this.readMem(this.pc++)+a&255;this.f=this.SZHVC_ADD_TABLE[a<<16|this.a<<8|b];this.a=b},207:function(){this.writeMem(--this.sp,this.pc>>8);this.writeMem(--this.sp,this.pc&255);this.pc=8},208:function(){0==
(this.f&F_CARRY)&&(this.pc=this.readMemWord(this.sp),this.sp+=2,this.tstates-=6)},209:function(){var a=this.readMemWord(this.sp);this.d=a>>8;this.e=a&255;this.sp+=2},210:function(){this.pc=0==(this.f&F_CARRY)?this.readMemWord(this.pc):this.pc+2},211:function(){this.port.out(this.readMem(this.pc++),this.a)},212:function(){0==(this.f&F_CARRY)?(this.writeMem(--this.sp,this.pc+2>>8),this.writeMem(--this.sp,this.pc+2&255),this.pc=this.readMemWord(this.pc),this.tstates-=7):this.pc+=2},213:function(){this.writeMem(--this.sp,
this.d);this.writeMem(--this.sp,this.e)},214:function(){var a=this.a-this.readMem(this.pc++)&255;this.f=this.SZHVC_SUB_TABLE[this.a<<8|a];this.a=a},215:function(){this.writeMem(--this.sp,this.pc>>8);this.writeMem(--this.sp,this.pc&255);this.pc=16},216:function(){0!=(this.f&F_CARRY)&&(this.pc=this.readMemWord(this.sp),this.sp+=2,this.tstates-=6)},217:function(){var a=this.b;this.b=this.b2;this.b2=a;a=this.c;this.c=this.c2;this.c2=a;a=this.d;this.d=this.d2;this.d2=a;a=this.e;this.e=this.e2;this.e2=
a;a=this.h;this.h=this.h2;this.h2=a;a=this.l;this.l=this.l2;this.l2=a},218:function(){this.pc=0!=(this.f&F_CARRY)?this.readMemWord(this.pc):this.pc+2},219:function(){this.a=this.port.in_(this.readMem(this.pc++))},220:function(){0!=(this.f&F_CARRY)?(this.writeMem(--this.sp,this.pc+2>>8),this.writeMem(--this.sp,this.pc+2&255),this.pc=this.readMemWord(this.pc),this.tstates-=7):this.pc+=2},221:function(){this.doIndexOpIX(this.readMem(this.pc++))},222:function(){var a=this.f&F_CARRY,b=this.a-this.readMem(this.pc++)-
a&255;this.f=this.SZHVC_SUB_TABLE[a<<16|this.a<<8|b];this.a=b},223:function(){this.writeMem(--this.sp,this.pc>>8);this.writeMem(--this.sp,this.pc&255);this.pc=24},224:function(){0==(this.f&F_PARITY)&&(this.pc=this.readMemWord(this.sp),this.sp+=2,this.tstates-=6)},225:function(){var a=this.readMemWord(this.sp);this.h=a>>8;this.l=a&255;this.sp+=2},226:function(){this.pc=0==(this.f&F_PARITY)?this.readMemWord(this.pc):this.pc+2},227:function(){var a=this.h;this.h=this.readMem(this.sp+1);this.writeMem(this.sp+
1,a);a=this.l;this.l=this.readMem(this.sp);this.writeMem(this.sp,a)},228:function(){0==(this.f&F_PARITY)?(this.writeMem(--this.sp,this.pc+2>>8),this.writeMem(--this.sp,this.pc+2&255),this.pc=this.readMemWord(this.pc),this.tstates-=7):this.pc+=2},229:function(){this.writeMem(--this.sp,this.h);this.writeMem(--this.sp,this.l)},230:function(){this.f=this.SZP_TABLE[this.a&=this.readMem(this.pc++)]|F_HALFCARRY},231:function(){this.writeMem(--this.sp,this.pc>>8);this.writeMem(--this.sp,this.pc&255);this.pc=
32},232:function(){0!=(this.f&F_PARITY)&&(this.pc=this.readMemWord(this.sp),this.sp+=2,this.tstates-=6)},233:function(){this.pc=this.h<<8|this.l},234:function(){this.pc=0!=(this.f&F_PARITY)?this.readMemWord(this.pc):this.pc+2},235:function(){var a=this.d;this.d=this.h;this.h=a;a=this.e;this.e=this.l;this.l=a},236:function(){0!=(this.f&F_PARITY)?(this.writeMem(--this.sp,this.pc+2>>8),this.writeMem(--this.sp,this.pc+2&255),this.pc=this.readMemWord(this.pc),this.tstates-=7):this.pc+=2},237:function(){this.doED(this.readMem(this.pc))},
238:function(){this.f=this.SZP_TABLE[this.a^=this.readMem(this.pc++)]},239:function(){this.writeMem(--this.sp,this.pc>>8);this.writeMem(--this.sp,this.pc&255);this.pc=40},240:function(){0==(this.f&F_SIGN)&&(this.pc=this.readMemWord(this.sp),this.sp+=2,this.tstates-=6)},241:function(){this.f=this.readMem(this.sp++);this.a=this.readMem(this.sp++)},242:function(){this.pc=0==(this.f&F_SIGN)?this.readMemWord(this.pc):this.pc+2},243:function(){this.iff1=this.iff2=!1;this.EI_inst=!0},244:function(){0==(this.f&
F_SIGN)?(this.writeMem(--this.sp,this.pc+2>>8),this.writeMem(--this.sp,this.pc+2&255),this.pc=this.readMemWord(this.pc),this.tstates-=7):this.pc+=2},245:function(){this.writeMem(--this.sp,this.a);this.writeMem(--this.sp,this.f)},246:function(){this.f=this.SZP_TABLE[this.a|=this.readMem(this.pc++)]},247:function(){this.writeMem(--this.sp,this.pc>>8);this.writeMem(--this.sp,this.pc&255);this.pc=48},248:function(){0!=(this.f&F_SIGN)&&(this.pc=this.readMemWord(this.sp),this.sp+=2,this.tstates-=6)},249:function(){this.sp=
this.h<<8|this.l},250:function(){this.pc=0!=(this.f&F_SIGN)?this.readMemWord(this.pc):this.pc+2},251:function(){this.EI_inst=this.iff1=this.iff2=!0},252:function(){0!=(this.f&F_SIGN)?(this.writeMem(--this.sp,this.pc+2>>8),this.writeMem(--this.sp,this.pc+2&255),this.pc=this.readMemWord(this.pc),this.tstates-=7):this.pc+=2},253:function(){this.doIndexOpIY(this.readMem(this.pc++))},254:function(){this.f=this.SZHVC_SUB_TABLE[this.a<<8|this.a-this.readMem(this.pc++)&255]},255:function(){this.writeMem(--this.sp,
this.pc>>8);this.writeMem(--this.sp,this.pc&255);this.pc=56}}[a].toString()};
function getOpCode(a){switch(a){case 0:return"NOP";case 1:return"LD BC,nn";case 2:return"LD (BC),A";case 3:return"INC BC";case 4:return"INC B";case 5:return"DEC B";case 6:return"LD B,n";case 7:return"RLCA";case 8:return"EX AF AF'";case 9:return"ADD HL,BC";case 10:return"LD A,(BC)";case 11:return"DEC BC";case 12:return"INC C";case 13:return"DEC C";case 14:return"LD C,n";case 15:return"RRCA";case 16:return"DJNZ (PC+e)";case 17:return"LD DE,nn";case 18:return"LD (DE), A";case 19:return"INC DE";case 20:return"INC D";
case 21:return"DEC D";case 22:return"LD D,n";case 23:return"RLA";case 24:return"JR (PC+e)";case 25:return"ADD HL,DE";case 26:return"LD A,(DE)";case 27:return"DEC DE";case 28:return"INC E";case 29:return"DEC E";case 30:return"LD E,N";case 31:return"RRA";case 32:return"JR NZ,(PC+e)";case 33:return"LD HL,nn";case 34:return"LD (nn),HL";case 35:return"INC HL";case 36:return"INC H";case 37:return"DEC H";case 38:return"LD H,n";case 39:return"DAA";case 40:return"JR Z,(PC+e)";case 41:return"ADD HL,HL";case 42:return"LD HL,(nn)";
case 43:return"DEC HL";case 44:return"INC L";case 45:return"DEC L";case 46:return"LD L,n";case 47:return"CPL";case 48:return"JR NC,(PC+e)";case 49:return"LD SP,nn";case 50:return"LD (nn),A";case 51:return"INC SP";case 52:return"INC (HL)";case 53:return"DEC (HL)";case 54:return"LD (HL),n";case 55:return"SCF";case 56:return"JR C,(PC+e)";case 57:return"ADD HL,SP";case 58:return"LD A,(nn)";case 59:return"DEC SP";case 60:return"INC A";case 61:return"DEC A";case 62:return"LD A,n";case 63:return"CCF";case 64:return"LD B,B";
case 65:return"LD B,C";case 66:return"LD B,D";case 67:return"LD B,E";case 68:return"LD B,H";case 69:return"LD B,L";case 70:return"LD B,(HL)";case 71:return"LD B,A";case 72:return"LD C,B";case 73:return"LD C,C";case 74:return"LD C,D";case 75:return"LD C,E";case 76:return"LD C,H";case 77:return"LD C,L";case 78:return"LD C,(HL)";case 79:return"LD C,A";case 80:return"LD D,B";case 81:return"LD D,C";case 82:return"LD D,D";case 83:return"LD D,E";case 84:return"LD D,H";case 85:return"LD D,L";case 86:return"LD D,(HL)";
case 87:return"LD D,A";case 88:return"LD E,B";case 89:return"LD E,C";case 90:return"LD E,D";case 91:return"LD E,E";case 92:return"LD E,H";case 93:return"LD E,L";case 94:return"LD E,(HL)";case 95:return"LD E,A";case 96:return"LD H,B";case 97:return"LD H,C";case 98:return"LD H,D";case 99:return"LD H,E";case 100:return"LD H,H";case 101:return"LD H,L";case 102:return"LD H,(HL)";case 103:return"LD H,A";case 104:return"LD L,B";case 105:return"LD L,C";case 106:return"LD L,D";case 107:return"LD L,E";case 108:return"LD L,H";
case 109:return"LD L,L";case 110:return"LD L,(HL)";case 111:return"LD L,A";case 112:return"LD (HL),B";case 113:return"LD (HL),C";case 114:return"LD (HL),D";case 115:return"LD (HL),E";case 116:return"LD (HL),H";case 117:return"LD (HL),L";case 118:return"HALT";case 119:return"LD (HL),A";case 120:return"LD A,B";case 121:return"LD A,C";case 122:return"LD A,D";case 123:return"LD A,E";case 124:return"LD A,H";case 125:return"LD A,L";case 126:return"LD A,(HL)";case 127:return"LD A,A";case 128:return"ADD A,B";
case 129:return"ADD A,C";case 130:return"ADD A,D";case 131:return"ADD A,E";case 132:return"ADD A,H";case 133:return"ADD A,L";case 134:return"ADD A,(HL)";case 135:return"ADD A,A";case 136:return"ADC A,B";case 137:return"ADC A,C";case 138:return"ADC A,D";case 139:return"ADC A,E";case 140:return"ADC A,H";case 141:return"ADC A,L";case 142:return"ADC A,(HL)";case 143:return"ADC A,A";case 144:return"SUB A,B";case 145:return"SUB A,C";case 146:return"SUB A,D";case 147:return"SUB A,E";case 148:return"SUB A,H";
case 149:return"SUB A,L";case 150:return"SUB A,(HL)";case 151:return"SUB A,A";case 152:return"SBC A,B";case 153:return"SBC A,C";case 154:return"SBC A,D";case 155:return"SBC A,E";case 156:return"SBC A,H";case 157:return"SBC A,L";case 158:return"SBC A,(HL)";case 159:return"SBC A,A";case 160:return"AND A,B";case 161:return"AND A,C";case 162:return"AND A,D";case 163:return"AND A,E";case 164:return"AND A,H";case 165:return"AND A,L";case 166:return"AND A,(HL)";case 167:return"AND A,A";case 168:return"XOR A,B";
case 169:return"XOR A,C";case 170:return"XOR A,D";case 171:return"XOR A,E";case 172:return"XOR A,H";case 173:return"XOR A,L";case 174:return"XOR A,(HL)";case 175:return"XOR A,A (=0)";case 176:return"OR A,B";case 177:return"OR A,C";case 178:return"OR A,D";case 179:return"OR A,E";case 180:return"OR A,H";case 181:return"OR A,L";case 182:return"OR A,(HL)";case 183:return"OR A,A";case 184:return"CP A,B";case 185:return"CP A,C";case 186:return"CP A,D";case 187:return"CP A,E";case 188:return"CP A,H";case 189:return"CP A,L";
case 190:return"CP A,(HL)";case 191:return"CP A,A";case 192:return"RET NZ";case 193:return"POP BC";case 194:return"JP NZ,(nn)";case 195:return"JP (nn)";case 196:return"CALL NZ (nn)";case 197:return"PUSH BC";case 198:return"ADD A,n";case 199:return"RST 00H";case 200:return"RET Z";case 201:return"RET";case 202:return"JP Z,(nn)";case 203:return"CB Opcode";case 204:return"CALL Z (nn)";case 205:return"CALL (nn)";case 206:return"ADC A,n";case 207:return"RST 08H";case 208:return"RET NC";case 209:return"POP DE";
case 210:return"JP NC,(nn)";case 211:return"OUT (n),A";case 212:return"CALL NC (nn)";case 213:return"PUSH DE";case 214:return"SUB n";case 215:return"RST 10H";case 216:return"RET C";case 217:return"EXX";case 218:return"JP C,(nn)";case 219:return"IN A,(n)";case 220:return"CALL C (nn)";case 221:return"DD Opcode";case 222:return"SBC A,n";case 223:return"RST 18H";case 224:return"RET PO";case 225:return"POP HL";case 226:return"JP PO,(nn)";case 227:return"EX (SP),HL";case 228:return"CALL PO (nn)";case 229:return"PUSH HL";
case 230:return"AND (n)";case 231:return"RST 20H";case 232:return"RET PE";case 233:return"JP (HL)";case 234:return"JP PE,(nn)";case 235:return"EX DE,HL";case 236:return"CALL PE (nn)";case 237:return"ED Opcode";case 238:return"XOR n";case 239:return"RST 28H";case 240:return"RET P";case 241:return"POP AF";case 242:return"JP P,(nn)";case 243:return"DI";case 244:return"CALL P (nn)";case 245:return"PUSH AF";case 246:return"OR n";case 247:return"RST 30H";case 248:return"RET M";case 249:return"LD SP,HL";
case 250:return"JP M,(nn)";case 251:return"EI";case 252:return"CALL M (nn)";case 253:return"FD Opcode";case 254:return"CP n";case 255:return"RST 38H"}return"Unknown Opcode"};var HALT_SPEEDUP=!0,F_CARRY=1,F_NEGATIVE=2,F_PARITY=4,F_OVERFLOW=4,F_BIT3=8,F_HALFCARRY=16,F_BIT5=32,F_ZERO=64,F_SIGN=128,BIT_0=1,BIT_1=2,BIT_2=4,BIT_3=8,BIT_4=16,BIT_5=32,BIT_6=64,BIT_7=128,OP_STATES=[4,10,7,6,4,4,7,4,4,11,7,6,4,4,7,4,8,10,7,6,4,4,7,4,12,11,7,6,4,4,7,4,7,10,16,6,4,4,7,4,7,11,16,6,4,4,7,4,7,10,13,6,11,11,10,4,7,11,13,6,4,4,7,4,4,4,4,4,4,4,7,4,4,4,4,4,4,4,7,4,4,4,4,4,4,4,7,4,4,4,4,4,4,4,7,4,4,4,4,4,4,4,7,4,4,4,4,4,4,4,7,4,7,7,7,7,7,7,4,7,4,4,4,4,4,4,7,4,4,4,4,4,4,4,7,4,4,4,4,4,4,4,
7,4,4,4,4,4,4,4,7,4,4,4,4,4,4,4,7,4,4,4,4,4,4,4,7,4,4,4,4,4,4,4,7,4,4,4,4,4,4,4,7,4,4,4,4,4,4,4,7,4,5,10,10,10,10,11,7,11,5,10,10,0,10,17,7,11,5,10,10,11,10,11,7,11,5,4,10,11,10,0,7,11,5,10,10,19,10,11,7,11,5,4,10,4,10,0,7,11,5,10,10,4,10,11,7,11,5,6,10,4,10,0,7,11],OP_CB_STATES=[8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,12,8,8,8,8,8,8,8,12,8,8,8,8,8,8,8,12,8,8,8,8,8,8,8,12,8,8,8,8,8,8,8,12,8,
8,8,8,8,8,8,12,8,8,8,8,8,8,8,12,8,8,8,8,8,8,8,12,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8,8,8,8,8,8,8,15,8],OP_DD_STATES=[4,4,4,4,4,4,4,4,4,15,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,15,4,4,4,4,4,4,4,14,20,10,8,8,11,4,4,15,20,10,8,8,11,4,4,4,4,4,23,23,19,4,4,15,4,4,4,4,4,4,4,4,4,4,8,8,19,4,4,4,
4,4,8,8,19,4,4,4,4,4,8,8,19,4,4,4,4,4,8,8,19,4,8,8,8,8,8,8,19,8,8,8,8,8,8,8,19,8,19,19,19,19,19,19,4,19,4,4,4,4,8,8,19,4,4,4,4,4,8,8,19,4,4,4,4,4,8,8,19,4,4,4,4,4,8,8,19,4,4,4,4,4,8,8,19,4,4,4,4,4,8,8,19,4,4,4,4,4,8,8,19,4,4,4,4,4,8,8,19,4,4,4,4,4,8,8,19,4,4,4,4,4,4,4,4,4,4,4,4,0,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,14,4,23,4,15,4,4,4,8,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,10,4,4,4,4,4,4],OP_INDEX_CB_STATES=[0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,
0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,20,0,0,0,0,0,0,0,20,0,0,0,0,0,0,0,20,0,0,0,0,0,0,0,20,0,0,0,0,0,0,0,20,0,0,0,0,0,0,0,20,0,0,0,0,0,0,0,20,0,0,0,0,0,0,0,20,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0,0,0,0,0,0,0,23,0],OP_ED_STATES=[8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,12,12,15,20,8,14,8,9,12,12,15,20,8,14,8,9,12,12,15,20,8,14,8,9,12,12,15,20,8,14,8,9,12,12,15,20,8,14,8,18,12,12,15,20,8,14,8,18,8,12,15,20,8,14,8,8,12,12,15,20,8,14,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,16,16,16,16,8,8,8,8,16,16,16,16,8,8,8,8,16,16,16,16,8,8,8,8,16,16,16,16,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8];
JSSMS.Z80=function(a){this.main=a;this.port=a.ports;this.im=this.sp=this.pc=0;this.interruptLine=this.EI_inst=this.halt=this.iff2=this.iff1=!1;this.tstates=this.totalCycles=this.f2=this.f=this.i=this.r=this.iyH=this.iyL=this.ixH=this.ixL=this.l2=this.h2=this.l=this.h=this.e2=this.d2=this.e=this.d=this.c2=this.b2=this.c=this.b=this.a2=this.a=this.interruptVector=0;this.hitCounts=[];this.blocks=Object.create(null);this.prevOpcode=this.entryPC=0;this.blockInstructions=[];this.opcodeInstructions=buildOpcodeInsts();
this.rom=[];this.ram=Array(8);this.sram=null;this.useSRAM=!1;this.frameReg=Array(4);this.number_of_pages=0;this.memWriteMap=Array(65);this.memReadMap=Array(65);this.DAA_TABLE=Array(2048);this.SZ_TABLE=Array(256);this.SZP_TABLE=Array(256);this.SZHV_INC_TABLE=Array(256);this.SZHV_DEC_TABLE=Array(256);this.SZHVC_ADD_TABLE=Array(131072);this.SZHVC_SUB_TABLE=Array(131072);this.SZ_BIT_TABLE=Array(256);this.generateFlagTables();this.generateDAATable();this.generateMemory();this.writeMem=JSSMS.Utils.writeMem.bind(this,
this);this.readMem=JSSMS.Utils.readMem.bind(this,this.memReadMap);this.readMemWord=JSSMS.Utils.readMemWord.bind(this,this.memReadMap)};
JSSMS.Z80.prototype={reset:function(){this.pc=this.f2=this.f=this.i=this.r=this.iyL=this.iyH=this.ixL=this.ixH=this.h=this.l=this.h2=this.l2=this.d=this.e=this.d2=this.e2=this.b=this.c=this.b2=this.c2=this.a=this.a2=0;this.sp=57328;this.im=this.totalCycles=this.tstates=0;this.EI_inst=this.iff2=this.iff1=!1;this.interruptVector=0;this.halt=!1;this.blocks=Object.create(null);this.entryPC=0;this.prevOpcode=this.readMem(0);this.blockInstructions=[this.prevOpcode]},getOp:function(){var a=this.readMem(this.pc),
b=(a&255).toString(16);switch(a){case 203:case 237:a=this.readMem(this.pc+1);b+=" "+(a&255).toString(16);break;case 221:case 253:a=this.readMem(this.pc+1),b+=" "+(a&255).toString(16),203==a&&(a=this.readMem(this.pc+3),b+=" "+(a&255).toString(16))}return b.toUpperCase()},getMnu:function(){this.readMem(this.pc)},consoledebug:function(){console.log("----------------------------------------------------------------------------");console.log(this.pc.toString(16)+" 0x"+this.getOp()+" ");console.log("A: "+
this.a.toString(16)+" BC: "+this.getBC().toString(16)+" DE: "+this.getDE().toString(16)+" HL: "+this.getHL().toString(16)+" IX: "+this.getIX().toString(16)+" IY: "+this.getIY().toString(16));this.exAF();this.exBC();this.exDE();this.exHL();console.log("A': "+this.a.toString(16)+" BC': "+this.getBC().toString(16)+" DE': "+this.getDE().toString(16)+" HL': "+this.getHL().toString(16)+" SP: "+this.sp.toString(16));this.exAF();this.exBC();this.exDE();this.exHL()},run:function(a,b){var c=this,d=0,d=d=0;
this.tstates+=a;0!=a&&(this.totalCycles=a);for(Setup.ACCURATE_INTERRUPT_EMULATION||this.interruptLine&&this.interrupt();this.tstates>b;){if(ENABLE_DYNAREC&&this.blocks[this.pc]){this.blocks[this.pc].call(this,b);this.entryPC=this.pc;this.blockInstructions=[];break}Setup.ACCURATE_INTERRUPT_EMULATION&&this.interruptLine&&this.interrupt();d=this.readMem(this.pc);if(isEndingInst(this.prevOpcode)){this.hitCounts[this.entryPC]++;if(this.hitCounts[this.pc]>=HOT_BLOCK_THRESHOLD&&this.blockInstructions.length){var e=
this.blockInstructions.length,f=this.blockInstructions.map(function(a){return c.opcodeInstructions[a]}).join("\nif (!(this.tstates > cyclesTo)) return;\n\n"),f=(new Function("return function block_"+toHex(this.entryPC)+"_"+e+"(cyclesTo) {\n"+f+"}"))();this.blocks[this.entryPC]=f}this.entryPC=this.pc;this.blockInstructions=[]}this.prevOpcode=d;this.blockInstructions.push(d);this.pc++;Setup.ACCURATE_INTERRUPT_EMULATION&&(this.EI_inst=!1);this.tstates-=OP_STATES[d];Setup.REFRESH_EMULATION&&this.incR();
switch(d){case 1:this.c=this.readMem(this.pc++);this.b=this.readMem(this.pc++);break;case 2:this.writeMem(this.getBC(),this.a);break;case 3:this.incBC();break;case 4:this.b=this.inc8(this.b);break;case 5:this.b=this.dec8(this.b);break;case 6:this.b=this.readMem(this.pc++);break;case 7:this.rlca_a();break;case 8:this.exAF();break;case 9:this.setHL(this.add16(this.getHL(),this.getBC()));break;case 10:this.a=this.readMem(this.getBC());break;case 11:this.decBC();break;case 12:this.c=this.inc8(this.c);
break;case 13:this.c=this.dec8(this.c);break;case 14:this.c=this.readMem(this.pc++);break;case 15:this.rrca_a();break;case 16:this.b=this.b-1&255;this.jr(0!=this.b);break;case 17:this.e=this.readMem(this.pc++);this.d=this.readMem(this.pc++);break;case 18:this.writeMem(this.getDE(),this.a);break;case 19:this.incDE();break;case 20:this.d=this.inc8(this.d);break;case 21:this.d=this.dec8(this.d);break;case 22:this.d=this.readMem(this.pc++);break;case 23:this.rla_a();break;case 24:this.pc+=this.d_()+1;
break;case 25:this.setHL(this.add16(this.getHL(),this.getDE()));break;case 26:this.a=this.readMem(this.getDE());break;case 27:this.decDE();break;case 28:this.e=this.inc8(this.e);break;case 29:this.e=this.dec8(this.e);break;case 30:this.e=this.readMem(this.pc++);break;case 31:this.rra_a();break;case 32:this.jr(0==(this.f&F_ZERO));break;case 33:this.l=this.readMem(this.pc++);this.h=this.readMem(this.pc++);break;case 34:d=this.readMemWord(this.pc);this.writeMem(d,this.l);this.writeMem(++d,this.h);this.pc+=
2;break;case 35:this.incHL();break;case 36:this.h=this.inc8(this.h);break;case 37:this.h=this.dec8(this.h);break;case 38:this.h=this.readMem(this.pc++);break;case 39:this.daa();break;case 40:this.jr(0!=(this.f&F_ZERO));break;case 41:this.setHL(this.add16(this.getHL(),this.getHL()));break;case 42:d=this.readMemWord(this.pc);this.l=this.readMem(d);this.h=this.readMem(d+1);this.pc+=2;break;case 43:this.decHL();break;case 44:this.l=this.inc8(this.l);break;case 45:this.l=this.dec8(this.l);break;case 46:this.l=
this.readMem(this.pc++);break;case 47:this.cpl_a();break;case 48:this.jr(0==(this.f&F_CARRY));break;case 49:this.sp=this.readMemWord(this.pc);this.pc+=2;break;case 50:this.writeMem(this.readMemWord(this.pc),this.a);this.pc+=2;break;case 51:this.sp++;break;case 52:this.incMem(this.getHL());break;case 53:this.decMem(this.getHL());break;case 54:this.writeMem(this.getHL(),this.readMem(this.pc++));break;case 55:this.f|=F_CARRY;this.f&=~F_NEGATIVE;this.f&=~F_HALFCARRY;break;case 56:this.jr(0!=(this.f&F_CARRY));
break;case 57:this.setHL(this.add16(this.getHL(),this.sp));break;case 58:this.a=this.readMem(this.readMemWord(this.pc));this.pc+=2;break;case 59:this.sp--;break;case 60:this.a=this.inc8(this.a);break;case 61:this.a=this.dec8(this.a);break;case 62:this.a=this.readMem(this.pc++);break;case 63:this.ccf();break;case 65:this.b=this.c;break;case 66:this.b=this.d;break;case 67:this.b=this.e;break;case 68:this.b=this.h;break;case 69:this.b=this.l;break;case 70:this.b=this.readMem(this.getHL());break;case 71:this.b=
this.a;break;case 72:this.c=this.b;break;case 74:this.c=this.d;break;case 75:this.c=this.e;break;case 76:this.c=this.h;break;case 77:this.c=this.l;break;case 78:this.c=this.readMem(this.getHL());break;case 79:this.c=this.a;break;case 80:this.d=this.b;break;case 81:this.d=this.c;break;case 83:this.d=this.e;break;case 84:this.d=this.h;break;case 85:this.d=this.l;break;case 86:this.d=this.readMem(this.getHL());break;case 87:this.d=this.a;break;case 88:this.e=this.b;break;case 89:this.e=this.c;break;
case 90:this.e=this.d;break;case 92:this.e=this.h;break;case 93:this.e=this.l;break;case 94:this.e=this.readMem(this.getHL());break;case 95:this.e=this.a;break;case 96:this.h=this.b;break;case 97:this.h=this.c;break;case 98:this.h=this.d;break;case 99:this.h=this.e;break;case 101:this.h=this.l;break;case 102:this.h=this.readMem(this.getHL());break;case 103:this.h=this.a;break;case 104:this.l=this.b;break;case 105:this.l=this.c;break;case 106:this.l=this.d;break;case 107:this.l=this.e;break;case 108:this.l=
this.h;break;case 110:this.l=this.readMem(this.getHL());break;case 111:this.l=this.a;break;case 112:this.writeMem(this.getHL(),this.b);break;case 113:this.writeMem(this.getHL(),this.c);break;case 114:this.writeMem(this.getHL(),this.d);break;case 115:this.writeMem(this.getHL(),this.e);break;case 116:this.writeMem(this.getHL(),this.h);break;case 117:this.writeMem(this.getHL(),this.l);break;case 118:HALT_SPEEDUP&&(this.tstates=0);this.halt=!0;this.pc--;break;case 119:this.writeMem(this.getHL(),this.a);
break;case 120:this.a=this.b;break;case 121:this.a=this.c;break;case 122:this.a=this.d;break;case 123:this.a=this.e;break;case 124:this.a=this.h;break;case 125:this.a=this.l;break;case 126:this.a=this.readMem(this.getHL());break;case 128:this.add_a(this.b);break;case 129:this.add_a(this.c);break;case 130:this.add_a(this.d);break;case 131:this.add_a(this.e);break;case 132:this.add_a(this.h);break;case 133:this.add_a(this.l);break;case 134:this.add_a(this.readMem(this.getHL()));break;case 135:this.add_a(this.a);
break;case 136:this.adc_a(this.b);break;case 137:this.adc_a(this.c);break;case 138:this.adc_a(this.d);break;case 139:this.adc_a(this.e);break;case 140:this.adc_a(this.h);break;case 141:this.adc_a(this.l);break;case 142:this.adc_a(this.readMem(this.getHL()));break;case 143:this.adc_a(this.a);break;case 144:this.sub_a(this.b);break;case 145:this.sub_a(this.c);break;case 146:this.sub_a(this.d);break;case 147:this.sub_a(this.e);break;case 148:this.sub_a(this.h);break;case 149:this.sub_a(this.l);break;
case 150:this.sub_a(this.readMem(this.getHL()));break;case 151:this.sub_a(this.a);break;case 152:this.sbc_a(this.b);break;case 153:this.sbc_a(this.c);break;case 154:this.sbc_a(this.d);break;case 155:this.sbc_a(this.e);break;case 156:this.sbc_a(this.h);break;case 157:this.sbc_a(this.l);break;case 158:this.sbc_a(this.readMem(this.getHL()));break;case 159:this.sbc_a(this.a);break;case 160:this.f=this.SZP_TABLE[this.a&=this.b]|F_HALFCARRY;break;case 161:this.f=this.SZP_TABLE[this.a&=this.c]|F_HALFCARRY;
break;case 162:this.f=this.SZP_TABLE[this.a&=this.d]|F_HALFCARRY;break;case 163:this.f=this.SZP_TABLE[this.a&=this.e]|F_HALFCARRY;break;case 164:this.f=this.SZP_TABLE[this.a&=this.h]|F_HALFCARRY;break;case 165:this.f=this.SZP_TABLE[this.a&=this.l]|F_HALFCARRY;break;case 166:this.f=this.SZP_TABLE[this.a&=this.readMem(this.getHL())]|F_HALFCARRY;break;case 167:this.f=this.SZP_TABLE[this.a]|F_HALFCARRY;break;case 168:this.f=this.SZP_TABLE[this.a^=this.b];break;case 169:this.f=this.SZP_TABLE[this.a^=this.c];
break;case 170:this.f=this.SZP_TABLE[this.a^=this.d];break;case 171:this.f=this.SZP_TABLE[this.a^=this.e];break;case 172:this.f=this.SZP_TABLE[this.a^=this.h];break;case 173:this.f=this.SZP_TABLE[this.a^=this.l];break;case 174:this.f=this.SZP_TABLE[this.a^=this.readMem(this.getHL())];break;case 175:this.f=this.SZP_TABLE[this.a=0];break;case 176:this.f=this.SZP_TABLE[this.a|=this.b];break;case 177:this.f=this.SZP_TABLE[this.a|=this.c];break;case 178:this.f=this.SZP_TABLE[this.a|=this.d];break;case 179:this.f=
this.SZP_TABLE[this.a|=this.e];break;case 180:this.f=this.SZP_TABLE[this.a|=this.h];break;case 181:this.f=this.SZP_TABLE[this.a|=this.l];break;case 182:this.f=this.SZP_TABLE[this.a|=this.readMem(this.getHL())];break;case 183:this.f=this.SZP_TABLE[this.a];break;case 184:this.cp_a(this.b);break;case 185:this.cp_a(this.c);break;case 186:this.cp_a(this.d);break;case 187:this.cp_a(this.e);break;case 188:this.cp_a(this.h);break;case 189:this.cp_a(this.l);break;case 190:this.cp_a(this.readMem(this.getHL()));
break;case 191:this.cp_a(this.a);break;case 192:this.ret(0==(this.f&F_ZERO));break;case 193:this.setBC(this.readMemWord(this.sp));this.sp+=2;break;case 194:this.jp(0==(this.f&F_ZERO));break;case 195:this.pc=this.readMemWord(this.pc);break;case 196:this.call(0==(this.f&F_ZERO));break;case 197:this.push2(this.b,this.c);break;case 198:this.add_a(this.readMem(this.pc++));break;case 199:this.push1(this.pc);this.pc=0;break;case 200:this.ret(0!=(this.f&F_ZERO));break;case 201:this.pc=this.readMemWord(this.sp);
this.sp+=2;break;case 202:this.jp(0!=(this.f&F_ZERO));break;case 203:this.doCB(this.readMem(this.pc++));break;case 204:this.call(0!=(this.f&F_ZERO));break;case 205:this.push1(this.pc+2);this.pc=this.readMemWord(this.pc);break;case 206:this.adc_a(this.readMem(this.pc++));break;case 207:this.push1(this.pc);this.pc=8;break;case 208:this.ret(0==(this.f&F_CARRY));break;case 209:this.setDE(this.readMemWord(this.sp));this.sp+=2;break;case 210:this.jp(0==(this.f&F_CARRY));break;case 211:this.port.out(this.readMem(this.pc++),
this.a);break;case 212:this.call(0==(this.f&F_CARRY));break;case 213:this.push2(this.d,this.e);break;case 214:this.sub_a(this.readMem(this.pc++));break;case 215:this.push1(this.pc);this.pc=16;break;case 216:this.ret(0!=(this.f&F_CARRY));break;case 217:this.exBC();this.exDE();this.exHL();break;case 218:this.jp(0!=(this.f&F_CARRY));break;case 219:this.a=this.port.in_(this.readMem(this.pc++));break;case 220:this.call(0!=(this.f&F_CARRY));break;case 221:this.doIndexOpIX(this.readMem(this.pc++));break;
case 222:this.sbc_a(this.readMem(this.pc++));break;case 223:this.push1(this.pc);this.pc=24;break;case 224:this.ret(0==(this.f&F_PARITY));break;case 225:this.setHL(this.readMemWord(this.sp));this.sp+=2;break;case 226:this.jp(0==(this.f&F_PARITY));break;case 227:d=this.h;this.h=this.readMem(this.sp+1);this.writeMem(this.sp+1,d);d=this.l;this.l=this.readMem(this.sp);this.writeMem(this.sp,d);break;case 228:this.call(0==(this.f&F_PARITY));break;case 229:this.push2(this.h,this.l);break;case 230:this.f=
this.SZP_TABLE[this.a&=this.readMem(this.pc++)]|F_HALFCARRY;break;case 231:this.push1(this.pc);this.pc=32;break;case 232:this.ret(0!=(this.f&F_PARITY));break;case 233:this.pc=this.getHL();break;case 234:this.jp(0!=(this.f&F_PARITY));break;case 235:d=this.d;this.d=this.h;this.h=d;d=this.e;this.e=this.l;this.l=d;break;case 236:this.call(0!=(this.f&F_PARITY));break;case 237:this.doED(this.readMem(this.pc));break;case 238:this.f=this.SZP_TABLE[this.a^=this.readMem(this.pc++)];break;case 239:this.push1(this.pc);
this.pc=40;break;case 240:this.ret(0==(this.f&F_SIGN));break;case 241:this.f=this.readMem(this.sp++);this.a=this.readMem(this.sp++);break;case 242:this.jp(0==(this.f&F_SIGN));break;case 243:this.iff1=this.iff2=!1;this.EI_inst=!0;break;case 244:this.call(0==(this.f&F_SIGN));break;case 245:this.push2(this.a,this.f);break;case 246:this.f=this.SZP_TABLE[this.a|=this.readMem(this.pc++)];break;case 247:this.push1(this.pc);this.pc=48;break;case 248:this.ret(0!=(this.f&F_SIGN));break;case 249:this.sp=this.getHL();
break;case 250:this.jp(0!=(this.f&F_SIGN));break;case 251:this.iff1=this.iff2=this.EI_inst=!0;break;case 252:this.call(0!=(this.f&F_SIGN));break;case 253:this.doIndexOpIY(this.readMem(this.pc++));break;case 254:this.cp_a(this.readMem(this.pc++));break;case 255:this.push1(this.pc),this.pc=56}}},getCycle:function(){return this.totalCycles-this.tstates},nmi:function(){this.iff2=this.iff1;this.iff1=!1;Setup.REFRESH_EMULATION&&this.incR();this.halt&&(this.pc++,this.halt=!1);this.push1(this.pc);this.pc=
102;this.tstates-=11},interrupt:function(){if(this.iff1&&(!Setup.ACCURATE_INTERRUPT_EMULATION||!this.EI_inst))this.halt&&(this.pc++,this.halt=!1),Setup.REFRESH_EMULATION&&this.incR(),this.interruptLine=this.iff1=this.iff2=!1,this.push1(this.pc),0==this.im?(this.pc=0==this.interruptVector||255==this.interruptVector?56:this.interruptVector,this.tstates-=13):1==this.im?(this.pc=56,this.tstates-=13):(this.pc=this.readMemWord((this.i<<8)+this.interruptVector),this.tstates-=19)},jp:function(a){this.pc=
a?this.readMemWord(this.pc):this.pc+2},jr:function(a){a?(a=this.d_()+1,128<=a&&(a-=256),this.pc+=a,this.tstates-=5):this.pc++},call:function(a){a?(this.push1(this.pc+2),this.pc=this.readMemWord(this.pc),this.tstates-=7):this.pc+=2},ret:function(a){a&&(this.pc=this.readMemWord(this.sp),this.sp+=2,this.tstates-=6)},push1:function(a){this.writeMem(--this.sp,a>>8);this.writeMem(--this.sp,a&255)},push2:function(a,b){this.writeMem(--this.sp,a);this.writeMem(--this.sp,b)},incMem:function(a){this.writeMem(a,
this.inc8(this.readMem(a)))},decMem:function(a){this.writeMem(a,this.dec8(this.readMem(a)))},ccf:function(){0!=(this.f&F_CARRY)?(this.f&=~F_CARRY,this.f|=F_HALFCARRY):(this.f|=F_CARRY,this.f&=~F_HALFCARRY);this.f&=~F_NEGATIVE},daa:function(){var a=this.DAA_TABLE[this.a|(this.f&F_CARRY)<<8|(this.f&F_NEGATIVE)<<8|(this.f&F_HALFCARRY)<<6];this.a=a&255;this.f=this.f&F_NEGATIVE|a>>8},doCB:function(a){this.tstates-=OP_CB_STATES[a];Setup.REFRESH_EMULATION&&this.incR();switch(a){case 0:this.b=this.rlc(this.b);
break;case 1:this.c=this.rlc(this.c);break;case 2:this.d=this.rlc(this.d);break;case 3:this.e=this.rlc(this.e);break;case 4:this.h=this.rlc(this.h);break;case 5:this.l=this.rlc(this.l);break;case 6:this.writeMem(this.getHL(),this.rlc(this.readMem(this.getHL())));break;case 7:this.a=this.rlc(this.a);break;case 8:this.b=this.rrc(this.b);break;case 9:this.c=this.rrc(this.c);break;case 10:this.d=this.rrc(this.d);break;case 11:this.e=this.rrc(this.e);break;case 12:this.h=this.rrc(this.h);break;case 13:this.l=
this.rrc(this.l);break;case 14:this.writeMem(this.getHL(),this.rrc(this.readMem(this.getHL())));break;case 15:this.a=this.rrc(this.a);break;case 16:this.b=this.rl(this.b);break;case 17:this.c=this.rl(this.c);break;case 18:this.d=this.rl(this.d);break;case 19:this.e=this.rl(this.e);break;case 20:this.h=this.rl(this.h);break;case 21:this.l=this.rl(this.l);break;case 22:this.writeMem(this.getHL(),this.rl(this.readMem(this.getHL())));break;case 23:this.a=this.rl(this.a);break;case 24:this.b=this.rr(this.b);
break;case 25:this.c=this.rr(this.c);break;case 26:this.d=this.rr(this.d);break;case 27:this.e=this.rr(this.e);break;case 28:this.h=this.rr(this.h);break;case 29:this.l=this.rr(this.l);break;case 30:this.writeMem(this.getHL(),this.rr(this.readMem(this.getHL())));break;case 31:this.a=this.rr(this.a);break;case 32:this.b=this.sla(this.b);break;case 33:this.c=this.sla(this.c);break;case 34:this.d=this.sla(this.d);break;case 35:this.e=this.sla(this.e);break;case 36:this.h=this.sla(this.h);break;case 37:this.l=
this.sla(this.l);break;case 38:this.writeMem(this.getHL(),this.sla(this.readMem(this.getHL())));break;case 39:this.a=this.sla(this.a);break;case 40:this.b=this.sra(this.b);break;case 41:this.c=this.sra(this.c);break;case 42:this.d=this.sra(this.d);break;case 43:this.e=this.sra(this.e);break;case 44:this.h=this.sra(this.h);break;case 45:this.l=this.sra(this.l);break;case 46:this.writeMem(this.getHL(),this.sra(this.readMem(this.getHL())));break;case 47:this.a=this.sra(this.a);break;case 48:this.b=this.sll(this.b);
break;case 49:this.c=this.sll(this.c);break;case 50:this.d=this.sll(this.d);break;case 51:this.e=this.sll(this.e);break;case 52:this.h=this.sll(this.h);break;case 53:this.l=this.sll(this.l);break;case 54:this.writeMem(this.getHL(),this.sll(this.readMem(this.getHL())));break;case 55:this.a=this.sll(this.a);break;case 56:this.b=this.srl(this.b);break;case 57:this.c=this.srl(this.c);break;case 58:this.d=this.srl(this.d);break;case 59:this.e=this.srl(this.e);break;case 60:this.h=this.srl(this.h);break;
case 61:this.l=this.rl(this.l);break;case 62:this.writeMem(this.getHL(),this.srl(this.readMem(this.getHL())));break;case 63:this.a=this.srl(this.a);break;case 64:this.bit(this.b&BIT_0);break;case 65:this.bit(this.c&BIT_0);break;case 66:this.bit(this.d&BIT_0);break;case 67:this.bit(this.e&BIT_0);break;case 68:this.bit(this.h&BIT_0);break;case 69:this.bit(this.l&BIT_0);break;case 70:this.bit(this.readMem(this.getHL())&BIT_0);break;case 71:this.bit(this.a&BIT_0);break;case 72:this.bit(this.b&BIT_1);
break;case 73:this.bit(this.c&BIT_1);break;case 74:this.bit(this.d&BIT_1);break;case 75:this.bit(this.e&BIT_1);break;case 76:this.bit(this.h&BIT_1);break;case 77:this.bit(this.l&BIT_1);break;case 78:this.bit(this.readMem(this.getHL())&BIT_1);break;case 79:this.bit(this.a&BIT_1);break;case 80:this.bit(this.b&BIT_2);break;case 81:this.bit(this.c&BIT_2);break;case 82:this.bit(this.d&BIT_2);break;case 83:this.bit(this.e&BIT_2);break;case 84:this.bit(this.h&BIT_2);break;case 85:this.bit(this.l&BIT_2);
break;case 86:this.bit(this.readMem(this.getHL())&BIT_2);break;case 87:this.bit(this.a&BIT_2);break;case 88:this.bit(this.b&BIT_3);break;case 89:this.bit(this.c&BIT_3);break;case 90:this.bit(this.d&BIT_3);break;case 91:this.bit(this.e&BIT_3);break;case 92:this.bit(this.h&BIT_3);break;case 93:this.bit(this.l&BIT_3);break;case 94:this.bit(this.readMem(this.getHL())&BIT_3);break;case 95:this.bit(this.a&BIT_3);break;case 96:this.bit(this.b&BIT_4);break;case 97:this.bit(this.c&BIT_4);break;case 98:this.bit(this.d&
BIT_4);break;case 99:this.bit(this.e&BIT_4);break;case 100:this.bit(this.h&BIT_4);break;case 101:this.bit(this.l&BIT_4);break;case 102:this.bit(this.readMem(this.getHL())&BIT_4);break;case 103:this.bit(this.a&BIT_4);break;case 104:this.bit(this.b&BIT_5);break;case 105:this.bit(this.c&BIT_5);break;case 106:this.bit(this.d&BIT_5);break;case 107:this.bit(this.e&BIT_5);break;case 108:this.bit(this.h&BIT_5);break;case 109:this.bit(this.l&BIT_5);break;case 110:this.bit(this.readMem(this.getHL())&BIT_5);
break;case 111:this.bit(this.a&BIT_5);break;case 112:this.bit(this.b&BIT_6);break;case 113:this.bit(this.c&BIT_6);break;case 114:this.bit(this.d&BIT_6);break;case 115:this.bit(this.e&BIT_6);break;case 116:this.bit(this.h&BIT_6);break;case 117:this.bit(this.l&BIT_6);break;case 118:this.bit(this.readMem(this.getHL())&BIT_6);break;case 119:this.bit(this.a&BIT_6);break;case 120:this.bit(this.b&BIT_7);break;case 121:this.bit(this.c&BIT_7);break;case 122:this.bit(this.d&BIT_7);break;case 123:this.bit(this.e&
BIT_7);break;case 124:this.bit(this.h&BIT_7);break;case 125:this.bit(this.l&BIT_7);break;case 126:this.bit(this.readMem(this.getHL())&BIT_7);break;case 127:this.bit(this.a&BIT_7);break;case 128:this.b&=~BIT_0;break;case 129:this.c&=~BIT_0;break;case 130:this.d&=~BIT_0;break;case 131:this.e&=~BIT_0;break;case 132:this.h&=~BIT_0;break;case 133:this.l&=~BIT_0;break;case 134:this.writeMem(this.getHL(),this.readMem(this.getHL())&~BIT_0);break;case 135:this.a&=~BIT_0;break;case 136:this.b&=~BIT_1;break;
case 137:this.c&=~BIT_1;break;case 138:this.d&=~BIT_1;break;case 139:this.e&=~BIT_1;break;case 140:this.h&=~BIT_1;break;case 141:this.l&=~BIT_1;break;case 142:this.writeMem(this.getHL(),this.readMem(this.getHL())&~BIT_1);break;case 143:this.a&=~BIT_1;break;case 144:this.b&=~BIT_2;break;case 145:this.c&=~BIT_2;break;case 146:this.d&=~BIT_2;break;case 147:this.e&=~BIT_2;break;case 148:this.h&=~BIT_2;break;case 149:this.l&=~BIT_2;break;case 150:this.writeMem(this.getHL(),this.readMem(this.getHL())&~BIT_2);
break;case 151:this.a&=~BIT_2;break;case 152:this.b&=~BIT_3;break;case 153:this.c&=~BIT_3;break;case 154:this.d&=~BIT_3;break;case 155:this.e&=~BIT_3;break;case 156:this.h&=~BIT_3;break;case 157:this.l&=~BIT_3;break;case 158:this.writeMem(this.getHL(),this.readMem(this.getHL())&~BIT_3);break;case 159:this.a&=~BIT_3;break;case 160:this.b&=~BIT_4;break;case 161:this.c&=~BIT_4;break;case 162:this.d&=~BIT_4;break;case 163:this.e&=~BIT_4;break;case 164:this.h&=~BIT_4;break;case 165:this.l&=~BIT_4;break;
case 166:this.writeMem(this.getHL(),this.readMem(this.getHL())&~BIT_4);break;case 167:this.a&=~BIT_4;break;case 168:this.b&=~BIT_5;break;case 169:this.c&=~BIT_5;break;case 170:this.d&=~BIT_5;break;case 171:this.e&=~BIT_5;break;case 172:this.h&=~BIT_5;break;case 173:this.l&=~BIT_5;break;case 174:this.writeMem(this.getHL(),this.readMem(this.getHL())&~BIT_5);break;case 175:this.a&=~BIT_5;break;case 176:this.b&=~BIT_6;break;case 177:this.c&=~BIT_6;break;case 178:this.d&=~BIT_6;break;case 179:this.e&=
~BIT_6;break;case 180:this.h&=~BIT_6;break;case 181:this.l&=~BIT_6;break;case 182:this.writeMem(this.getHL(),this.readMem(this.getHL())&~BIT_6);break;case 183:this.a&=~BIT_6;break;case 184:this.b&=~BIT_7;break;case 185:this.c&=~BIT_7;break;case 186:this.d&=~BIT_7;break;case 187:this.e&=~BIT_7;break;case 188:this.h&=~BIT_7;break;case 189:this.l&=~BIT_7;break;case 190:this.writeMem(this.getHL(),this.readMem(this.getHL())&~BIT_7);break;case 191:this.a&=~BIT_7;break;case 192:this.b|=BIT_0;break;case 193:this.c|=
BIT_0;break;case 194:this.d|=BIT_0;break;case 195:this.e|=BIT_0;break;case 196:this.h|=BIT_0;break;case 197:this.l|=BIT_0;break;case 198:this.writeMem(this.getHL(),this.readMem(this.getHL())|BIT_0);break;case 199:this.a|=BIT_0;break;case 200:this.b|=BIT_1;break;case 201:this.c|=BIT_1;break;case 202:this.d|=BIT_1;break;case 203:this.e|=BIT_1;break;case 204:this.h|=BIT_1;break;case 205:this.l|=BIT_1;break;case 206:this.writeMem(this.getHL(),this.readMem(this.getHL())|BIT_1);break;case 207:this.a|=BIT_1;
break;case 208:this.b|=BIT_2;break;case 209:this.c|=BIT_2;break;case 210:this.d|=BIT_2;break;case 211:this.e|=BIT_2;break;case 212:this.h|=BIT_2;break;case 213:this.l|=BIT_2;break;case 214:this.writeMem(this.getHL(),this.readMem(this.getHL())|BIT_2);break;case 215:this.a|=BIT_2;break;case 216:this.b|=BIT_3;break;case 217:this.c|=BIT_3;break;case 218:this.d|=BIT_3;break;case 219:this.e|=BIT_3;break;case 220:this.h|=BIT_3;break;case 221:this.l|=BIT_3;break;case 222:this.writeMem(this.getHL(),this.readMem(this.getHL())|
BIT_3);break;case 223:this.a|=BIT_3;break;case 224:this.b|=BIT_4;break;case 225:this.c|=BIT_4;break;case 226:this.d|=BIT_4;break;case 227:this.e|=BIT_4;break;case 228:this.h|=BIT_4;break;case 229:this.l|=BIT_4;break;case 230:this.writeMem(this.getHL(),this.readMem(this.getHL())|BIT_4);break;case 231:this.a|=BIT_4;break;case 232:this.b|=BIT_5;break;case 233:this.c|=BIT_5;break;case 234:this.d|=BIT_5;break;case 235:this.e|=BIT_5;break;case 236:this.h|=BIT_5;break;case 237:this.l|=BIT_5;break;case 238:this.writeMem(this.getHL(),
this.readMem(this.getHL())|BIT_5);break;case 239:this.a|=BIT_5;break;case 240:this.b|=BIT_6;break;case 241:this.c|=BIT_6;break;case 242:this.d|=BIT_6;break;case 243:this.e|=BIT_6;break;case 244:this.h|=BIT_6;break;case 245:this.l|=BIT_6;break;case 246:this.writeMem(this.getHL(),this.readMem(this.getHL())|BIT_6);break;case 247:this.a|=BIT_6;break;case 248:this.b|=BIT_7;break;case 249:this.c|=BIT_7;break;case 250:this.d|=BIT_7;break;case 251:this.e|=BIT_7;break;case 252:this.h|=BIT_7;break;case 253:this.l|=
BIT_7;break;case 254:this.writeMem(this.getHL(),this.readMem(this.getHL())|BIT_7);break;case 255:this.a|=BIT_7;break;default:DEBUG&&console.log("Unimplemented CB Opcode: "+a.toString(16))}},rlc:function(a){var b=(a&128)>>7;a=(a<<1|a>>7)&255;this.f=b|this.SZP_TABLE[a];return a},rrc:function(a){var b=a&1;a=(a>>1|a<<7)&255;this.f=b|this.SZP_TABLE[a];return a},rl:function(a){var b=(a&128)>>7;a=(a<<1|this.f&F_CARRY)&255;this.f=b|this.SZP_TABLE[a];return a},rr:function(a){var b=a&1;a=(a>>1|this.f<<7)&255;
this.f=b|this.SZP_TABLE[a];return a},sla:function(a){var b=(a&128)>>7;a=a<<1&255;this.f=b|this.SZP_TABLE[a];return a},sll:function(a){var b=(a&128)>>7;a=(a<<1|1)&255;this.f=b|this.SZP_TABLE[a];return a},sra:function(a){var b=a&1;a=a>>1|a&128;this.f=b|this.SZP_TABLE[a];return a},srl:function(a){var b=a&1;a=a>>1&255;this.f=b|this.SZP_TABLE[a];return a},bit:function(a){this.f=this.f&F_CARRY|this.SZ_BIT_TABLE[a]},doIndexOpIX:function(a){var b=0,b=0;this.tstates-=OP_DD_STATES[a];Setup.REFRESH_EMULATION&&
this.incR();switch(a){case 9:this.setIX(this.add16(this.getIX(),this.getBC()));break;case 25:this.setIX(this.add16(this.getIX(),this.getDE()));break;case 33:this.setIX(this.readMemWord(this.pc));this.pc+=2;break;case 34:b=this.readMemWord(this.pc);this.writeMem(b++,this.ixL);this.writeMem(b,this.ixH);this.pc+=2;break;case 35:this.incIX();break;case 36:this.ixH=this.inc8(this.ixH);break;case 37:this.ixH=this.dec8(this.ixH);break;case 38:this.ixH=this.readMem(this.pc++);break;case 41:this.setIX(this.add16(this.getIX(),
this.getIX()));break;case 42:b=this.readMemWord(this.pc);this.ixL=this.readMem(b);this.ixH=this.readMem(++b);this.pc+=2;break;case 43:this.decIX();break;case 44:this.ixL=this.inc8(this.ixL);break;case 45:this.ixL=this.dec8(this.ixL);break;case 46:this.ixL=this.readMem(this.pc++);break;case 52:this.incMem(this.getIX()+this.d_());this.pc++;break;case 53:this.decMem(this.getIX()+this.d_());this.pc++;break;case 54:this.writeMem(this.getIX()+this.d_(),this.readMem(++this.pc));this.pc++;break;case 57:this.setIX(this.add16(this.getIX(),
this.sp));break;case 68:this.b=this.ixH;break;case 69:this.b=this.ixL;break;case 70:this.b=this.readMem(this.getIX()+this.d_());this.pc++;break;case 76:this.c=this.ixH;break;case 77:this.c=this.ixL;break;case 78:this.c=this.readMem(this.getIX()+this.d_());this.pc++;break;case 84:this.d=this.ixH;break;case 85:this.d=this.ixL;break;case 86:this.d=this.readMem(this.getIX()+this.d_());this.pc++;break;case 92:this.e=this.ixH;break;case 93:this.e=this.ixL;break;case 94:this.e=this.readMem(this.getIX()+
this.d_());this.pc++;break;case 96:this.ixH=this.b;break;case 97:this.ixH=this.c;break;case 98:this.ixH=this.d;break;case 99:this.ixH=this.e;break;case 100:break;case 101:this.ixH=this.ixL;break;case 102:this.h=this.readMem(this.getIX()+this.d_());this.pc++;break;case 103:this.ixH=this.a;break;case 104:this.ixL=this.b;break;case 105:this.ixL=this.c;break;case 106:this.ixL=this.d;break;case 107:this.ixL=this.e;break;case 108:this.ixL=this.ixH;break;case 109:break;case 110:this.l=this.readMem(this.getIX()+
this.d_());this.pc++;break;case 111:this.ixL=this.a;break;case 112:this.writeMem(this.getIX()+this.d_(),this.b);this.pc++;break;case 113:this.writeMem(this.getIX()+this.d_(),this.c);this.pc++;break;case 114:this.writeMem(this.getIX()+this.d_(),this.d);this.pc++;break;case 115:this.writeMem(this.getIX()+this.d_(),this.e);this.pc++;break;case 116:this.writeMem(this.getIX()+this.d_(),this.h);this.pc++;break;case 117:this.writeMem(this.getIX()+this.d_(),this.l);this.pc++;break;case 119:this.writeMem(this.getIX()+
this.d_(),this.a);this.pc++;break;case 124:this.a=this.ixH;break;case 125:this.a=this.ixL;break;case 126:this.a=this.readMem(this.getIX()+this.d_());this.pc++;break;case 132:this.add_a(this.ixH);break;case 133:this.add_a(this.ixL);break;case 134:this.add_a(this.readMem(this.getIX()+this.d_()));this.pc++;break;case 140:this.adc_a(this.ixH);break;case 141:this.adc_a(this.ixL);break;case 142:this.adc_a(this.readMem(this.getIX()+this.d_()));this.pc++;break;case 148:this.sub_a(this.ixH);break;case 149:this.sub_a(this.ixL);
break;case 150:this.sub_a(this.readMem(this.getIX()+this.d_()));this.pc++;break;case 156:this.sbc_a(this.ixH);break;case 157:this.sbc_a(this.ixL);break;case 158:this.sbc_a(this.readMem(this.getIX()+this.d_()));this.pc++;break;case 164:this.f=this.SZP_TABLE[this.a&=this.ixH]|F_HALFCARRY;break;case 165:this.f=this.SZP_TABLE[this.a&=this.ixL]|F_HALFCARRY;break;case 166:this.f=this.SZP_TABLE[this.a&=this.readMem(this.getIX()+this.d_())]|F_HALFCARRY;this.pc++;break;case 172:this.f=this.SZP_TABLE[this.a^=
this.ixH];break;case 173:this.f=this.SZP_TABLE[this.a^=this.ixL];break;case 174:this.f=this.SZP_TABLE[this.a^=this.readMem(this.getIX()+this.d_())];this.pc++;break;case 180:this.f=this.SZP_TABLE[this.a|=this.ixH];break;case 181:this.f=this.SZP_TABLE[this.a|=this.ixL];break;case 182:this.f=this.SZP_TABLE[this.a|=this.readMem(this.getIX()+this.d_())];this.pc++;break;case 188:this.cp_a(this.ixH);break;case 189:this.cp_a(this.ixL);break;case 190:this.cp_a(this.readMem(this.getIX()+this.d_()));this.pc++;
break;case 203:this.doIndexCB(this.getIX());break;case 225:this.setIX(this.readMemWord(this.sp));this.sp+=2;break;case 227:b=this.getIX();this.setIX(this.readMemWord(this.sp));this.writeMem(this.sp,b&255);this.writeMem(this.sp+1,b>>8);break;case 229:this.push2(this.ixH,this.ixL);break;case 233:this.pc=this.getIX();break;case 249:this.sp=this.getIX();break;default:this.pc--}},doIndexOpIY:function(a){this.tstates-=OP_DD_STATES[a];Setup.REFRESH_EMULATION&&this.incR();switch(a){case 9:this.setIY(this.add16(this.getIY(),
this.getBC()));break;case 25:this.setIY(this.add16(this.getIY(),this.getDE()));break;case 33:this.setIY(this.readMemWord(this.pc));this.pc+=2;break;case 34:a=this.readMemWord(this.pc);this.writeMem(a++,this.iyL);this.writeMem(a,this.iyH);this.pc+=2;break;case 35:this.incIY();break;case 36:this.iyH=this.inc8(this.iyH);break;case 37:this.iyH=this.dec8(this.iyH);break;case 38:this.iyH=this.readMem(this.pc++);break;case 41:this.setIY(this.add16(this.getIY(),this.getIY()));break;case 42:a=this.readMemWord(this.pc);
this.iyL=this.readMem(a);this.iyH=this.readMem(++a);this.pc+=2;break;case 43:this.decIY();break;case 44:this.iyL=this.inc8(this.iyL);break;case 45:this.iyL=this.dec8(this.iyL);break;case 46:this.iyL=this.readMem(this.pc++);break;case 52:this.incMem(this.getIY()+this.d_());this.pc++;break;case 53:this.decMem(this.getIY()+this.d_());this.pc++;break;case 54:this.writeMem(this.getIY()+this.d_(),this.readMem(++this.pc));this.pc++;break;case 57:this.setIY(this.add16(this.getIY(),this.sp));break;case 68:this.b=
this.iyH;break;case 69:this.b=this.iyL;break;case 70:this.b=this.readMem(this.getIY()+this.d_());this.pc++;break;case 76:this.c=this.iyH;break;case 77:this.c=this.iyL;break;case 78:this.c=this.readMem(this.getIY()+this.d_());this.pc++;break;case 84:this.d=this.iyH;break;case 85:this.d=this.iyL;break;case 86:this.d=this.readMem(this.getIY()+this.d_());this.pc++;break;case 92:this.e=this.iyH;break;case 93:this.e=this.iyL;break;case 94:this.e=this.readMem(this.getIY()+this.d_());this.pc++;break;case 96:this.iyH=
this.b;break;case 97:this.iyH=this.c;break;case 98:this.iyH=this.d;break;case 99:this.iyH=this.e;break;case 100:break;case 101:this.iyH=this.iyL;break;case 102:this.h=this.readMem(this.getIY()+this.d_());this.pc++;break;case 103:this.iyH=this.a;break;case 104:this.iyL=this.b;break;case 105:this.iyL=this.c;break;case 106:this.iyL=this.d;break;case 107:this.iyL=this.e;break;case 108:this.iyL=this.iyH;break;case 109:break;case 110:this.l=this.readMem(this.getIY()+this.d_());this.pc++;break;case 111:this.iyL=
this.a;break;case 112:this.writeMem(this.getIY()+this.d_(),this.b);this.pc++;break;case 113:this.writeMem(this.getIY()+this.d_(),this.c);this.pc++;break;case 114:this.writeMem(this.getIY()+this.d_(),this.d);this.pc++;break;case 115:this.writeMem(this.getIY()+this.d_(),this.e);this.pc++;break;case 116:this.writeMem(this.getIY()+this.d_(),this.h);this.pc++;break;case 117:this.writeMem(this.getIY()+this.d_(),this.l);this.pc++;break;case 119:this.writeMem(this.getIY()+this.d_(),this.a);this.pc++;break;
case 124:this.a=this.iyH;break;case 125:this.a=this.iyL;break;case 126:this.a=this.readMem(this.getIY()+this.d_());this.pc++;break;case 132:this.add_a(this.iyH);break;case 133:this.add_a(this.iyL);break;case 134:this.add_a(this.readMem(this.getIY()+this.d_()));this.pc++;break;case 140:this.adc_a(this.iyH);break;case 141:this.adc_a(this.iyL);break;case 142:this.adc_a(this.readMem(this.getIY()+this.d_()));this.pc++;break;case 148:this.sub_a(this.iyH);break;case 149:this.sub_a(this.iyL);break;case 150:this.sub_a(this.readMem(this.getIY()+
this.d_()));this.pc++;break;case 156:this.sbc_a(this.iyH);break;case 157:this.sbc_a(this.iyL);break;case 158:this.sbc_a(this.readMem(this.getIY()+this.d_()));this.pc++;break;case 164:this.f=this.SZP_TABLE[this.a&=this.iyH]|F_HALFCARRY;break;case 165:this.f=this.SZP_TABLE[this.a&=this.iyL]|F_HALFCARRY;break;case 166:this.f=this.SZP_TABLE[this.a&=this.readMem(this.getIY()+this.d_())]|F_HALFCARRY;this.pc++;break;case 172:this.f=this.SZP_TABLE[this.a^=this.iyH];break;case 173:this.f=this.SZP_TABLE[this.a^=
this.iyL];break;case 174:this.f=this.SZP_TABLE[this.a^=this.readMem(this.getIY()+this.d_())];this.pc++;break;case 180:this.f=this.SZP_TABLE[this.a|=this.iyH];break;case 181:this.f=this.SZP_TABLE[this.a|=this.iyL];break;case 182:this.f=this.SZP_TABLE[this.a|=this.readMem(this.getIY()+this.d_())];this.pc++;break;case 188:this.cp_a(this.iyH);break;case 189:this.cp_a(this.iyL);break;case 190:this.cp_a(this.readMem(this.getIY()+this.d_()));this.pc++;break;case 203:this.doIndexCB(this.getIY());break;case 225:this.setIY(this.readMemWord(this.sp));
this.sp+=2;break;case 227:a=this.getIY();this.setIY(this.readMemWord(this.sp));this.writeMem(this.sp,a&255);this.writeMem(this.sp+1,a>>8);break;case 229:this.push2(this.iyH,this.iyL);break;case 233:this.pc=this.getIY();break;case 249:this.sp=this.getIY();break;default:this.pc--}},doIndexCB:function(a){a=a+this.d_()&65535;var b=this.readMem(++this.pc);this.tstates-=OP_INDEX_CB_STATES[b];switch(b){case 6:this.writeMem(a,this.rlc(this.readMem(a)));break;case 14:this.writeMem(a,this.rrc(this.readMem(a)));
break;case 22:this.writeMem(a,this.rl(this.readMem(a)));break;case 30:this.writeMem(a,this.rr(this.readMem(a)));break;case 38:this.writeMem(a,this.sla(this.readMem(a)));break;case 46:this.writeMem(a,this.sra(this.readMem(a)));break;case 54:this.writeMem(a,this.sll(this.readMem(a)));break;case 62:this.writeMem(a,this.srl(this.readMem(a)));break;case 70:this.bit(this.readMem(a)&BIT_0);break;case 78:this.bit(this.readMem(a)&BIT_1);break;case 86:this.bit(this.readMem(a)&BIT_2);break;case 94:this.bit(this.readMem(a)&
BIT_3);break;case 102:this.bit(this.readMem(a)&BIT_4);break;case 110:this.bit(this.readMem(a)&BIT_5);break;case 118:this.bit(this.readMem(a)&BIT_6);break;case 126:this.bit(this.readMem(a)&BIT_7);break;case 134:this.writeMem(a,this.readMem(a)&~BIT_0);break;case 142:this.writeMem(a,this.readMem(a)&~BIT_1);break;case 150:this.writeMem(a,this.readMem(a)&~BIT_2);break;case 158:this.writeMem(a,this.readMem(a)&~BIT_3);break;case 166:this.writeMem(a,this.readMem(a)&~BIT_4);break;case 174:this.writeMem(a,
this.readMem(a)&~BIT_5);break;case 182:this.writeMem(a,this.readMem(a)&~BIT_6);break;case 190:this.writeMem(a,this.readMem(a)&~BIT_7);break;case 198:this.writeMem(a,this.readMem(a)|BIT_0);break;case 206:this.writeMem(a,this.readMem(a)|BIT_1);break;case 214:this.writeMem(a,this.readMem(a)|BIT_2);break;case 222:this.writeMem(a,this.readMem(a)|BIT_3);break;case 230:this.writeMem(a,this.readMem(a)|BIT_4);break;case 238:this.writeMem(a,this.readMem(a)|BIT_5);break;case 246:this.writeMem(a,this.readMem(a)|
BIT_6);break;case 254:this.writeMem(a,this.readMem(a)|BIT_7);break;default:DEBUG&&console.log("Unimplemented DDCB or FDCB Opcode: "+(b&255).toString(16))}this.pc++},doED:function(a){var b=0,c=b=0;this.tstates-=OP_ED_STATES[a];Setup.REFRESH_EMULATION&&this.incR();switch(a){case 64:this.b=this.port.in_(this.c);this.f=this.f&F_CARRY|this.SZP_TABLE[this.b];this.pc++;break;case 65:this.port.out(this.c,this.b);this.pc++;break;case 66:this.sbc16(this.getBC());this.pc++;break;case 67:b=this.readMemWord(this.pc+
1);this.writeMem(b++,this.c);this.writeMem(b,this.b);this.pc+=3;break;case 68:case 76:case 84:case 92:case 100:case 108:case 116:case 124:b=this.a;this.a=0;this.sub_a(b);this.pc++;break;case 69:case 77:case 85:case 93:case 101:case 109:case 117:case 125:this.pc=this.readMemWord(this.sp);this.sp+=2;this.iff1=this.iff2;break;case 70:case 78:case 102:case 110:this.im=0;this.pc++;break;case 71:this.i=this.a;this.pc++;break;case 72:this.c=this.port.in_(this.c);this.f=this.f&F_CARRY|this.SZP_TABLE[this.c];
this.pc++;break;case 73:this.port.out(this.c,this.c);this.pc++;break;case 74:this.adc16(this.getBC());this.pc++;break;case 75:b=this.readMemWord(this.pc+1);this.c=this.readMem(b++);this.b=this.readMem(b);this.pc+=3;break;case 79:this.r=this.a;this.pc++;break;case 80:this.d=this.port.in_(this.c);this.f=this.f&F_CARRY|this.SZP_TABLE[this.d];this.pc++;break;case 81:this.port.out(this.c,this.d);this.pc++;break;case 82:this.sbc16(this.getDE());this.pc++;break;case 83:b=this.readMemWord(this.pc+1);this.writeMem(b++,
this.e);this.writeMem(b,this.d);this.pc+=3;break;case 86:case 118:this.im=1;this.pc++;break;case 87:this.a=this.i;this.f=this.f&F_CARRY|this.SZ_TABLE[this.a]|(this.iff2?F_PARITY:0);this.pc++;break;case 88:this.e=this.port.in_(this.c);this.f=this.f&F_CARRY|this.SZP_TABLE[this.e];this.pc++;break;case 89:this.port.out(this.c,this.e);this.pc++;break;case 90:this.adc16(this.getDE());this.pc++;break;case 91:b=this.readMemWord(this.pc+1);this.e=this.readMem(b++);this.d=this.readMem(b);this.pc+=3;break;case 95:this.a=
Setup.REFRESH_EMULATION?this.r:JSSMS.Utils.rndInt(255);this.f=this.f&F_CARRY|this.SZ_TABLE[this.a]|(this.iff2?F_PARITY:0);this.pc++;break;case 96:this.h=this.port.in_(this.c);this.f=this.f&F_CARRY|this.SZP_TABLE[this.h];this.pc++;break;case 97:this.port.out(this.c,this.h);this.pc++;break;case 98:this.sbc16(this.getHL());this.pc++;break;case 99:b=this.readMemWord(this.pc+1);this.writeMem(b++,this.l);this.writeMem(b,this.h);this.pc+=3;break;case 103:b=this.getHL();c=this.readMem(b);this.writeMem(b,
c>>4|(this.a&15)<<4);this.a=this.a&240|c&15;this.f=this.f&F_CARRY|this.SZP_TABLE[this.a];this.pc++;break;case 104:this.l=this.port.in_(this.c);this.f=this.f&F_CARRY|this.SZP_TABLE[this.l];this.pc++;break;case 105:this.port.out(this.c,this.l);this.pc++;break;case 106:this.adc16(this.getHL());this.pc++;break;case 107:b=this.readMemWord(this.pc+1);this.l=this.readMem(b++);this.h=this.readMem(b);this.pc+=3;break;case 111:b=this.getHL();c=this.readMem(b);this.writeMem(b,(c&15)<<4|this.a&15);this.a=this.a&
240|c>>4;this.f=this.f&F_CARRY|this.SZP_TABLE[this.a];this.pc++;break;case 113:this.port.out(this.c,0);this.pc++;break;case 114:this.sbc16(this.sp);this.pc++;break;case 115:b=this.readMemWord(this.pc+1);this.writeMem(b++,this.sp&255);this.writeMem(b,this.sp>>8);this.pc+=3;break;case 120:this.a=this.port.in_(this.c);this.f=this.f&F_CARRY|this.SZP_TABLE[this.a];this.pc++;break;case 121:this.port.out(this.c,this.a);this.pc++;break;case 122:this.adc16(this.sp);this.pc++;break;case 123:this.sp=this.readMemWord(this.readMemWord(this.pc+
1));this.pc+=3;break;case 160:this.writeMem(this.getDE(),this.readMem(this.getHL()));this.incDE();this.incHL();this.decBC();this.f=this.f&193|(0!=this.getBC()?F_PARITY:0);this.pc++;break;case 161:b=this.f&F_CARRY|F_NEGATIVE;this.cp_a(this.readMem(this.getHL()));this.incHL();this.decBC();b|=0==this.getBC()?0:F_PARITY;this.f=this.f&248|b;this.pc++;break;case 162:b=this.port.in_(this.c);this.writeMem(this.getHL(),b);this.b=this.dec8(this.b);this.incHL();this.f=128==(b&128)?this.f|F_NEGATIVE:this.f&~F_NEGATIVE;
this.pc++;break;case 163:b=this.readMem(this.getHL());this.port.out(this.c,b);this.incHL();this.b=this.dec8(this.b);255<this.l+b?(this.f|=F_CARRY,this.f|=F_HALFCARRY):(this.f&=~F_CARRY,this.f&=~F_HALFCARRY);this.f=128==(b&128)?this.f|F_NEGATIVE:this.f&~F_NEGATIVE;this.pc++;break;case 168:this.writeMem(this.getDE(),this.readMem(this.getHL()));this.decDE();this.decHL();this.decBC();this.f=this.f&193|(0!=this.getBC()?F_PARITY:0);this.pc++;break;case 169:b=this.f&F_CARRY|F_NEGATIVE;this.cp_a(this.readMem(this.getHL()));
this.decHL();this.decBC();b|=0==this.getBC()?0:F_PARITY;this.f=this.f&248|b;this.pc++;break;case 170:b=this.port.in_(this.c);this.writeMem(this.getHL(),b);this.b=this.dec8(this.b);this.decHL();this.f=0!=(b&128)?this.f|F_NEGATIVE:this.f&~F_NEGATIVE;this.pc++;break;case 171:b=this.readMem(this.getHL());this.port.out(this.c,b);this.decHL();this.b=this.dec8(this.b);255<this.l+b?(this.f|=F_CARRY,this.f|=F_HALFCARRY):(this.f&=~F_CARRY,this.f&=~F_HALFCARRY);this.f=128==(b&128)?this.f|F_NEGATIVE:this.f&~F_NEGATIVE;
this.pc++;break;case 176:this.writeMem(this.getDE(),this.readMem(this.getHL()));this.incDE();this.incHL();this.decBC();0!=this.getBC()?(this.f|=F_PARITY,this.tstates-=5,this.pc--):(this.f&=~F_PARITY,this.pc++);this.f&=~F_NEGATIVE;this.f&=~F_HALFCARRY;break;case 177:b=this.f&F_CARRY|F_NEGATIVE;this.cp_a(this.readMem(this.getHL()));this.incHL();this.decBC();b|=0==this.getBC()?0:F_PARITY;0!=(b&F_PARITY)&&0==(this.f&F_ZERO)?(this.tstates-=5,this.pc--):this.pc++;this.f=this.f&248|b;break;case 178:b=this.port.in_(this.c);
this.writeMem(this.getHL(),b);this.b=this.dec8(this.b);this.incHL();0!=this.b?(this.tstates-=5,this.pc--):this.pc++;this.f=128==(b&128)?this.f|F_NEGATIVE:this.f&~F_NEGATIVE;break;case 179:b=this.readMem(this.getHL());this.port.out(this.c,b);this.b=this.dec8(this.b);this.incHL();0!=this.b?(this.tstates-=5,this.pc--):this.pc++;255<this.l+b?(this.f|=F_CARRY,this.f|=F_HALFCARRY):(this.f&=~F_CARRY,this.f&=~F_HALFCARRY);this.f=0!=(b&128)?this.f|F_NEGATIVE:this.f&~F_NEGATIVE;break;case 184:this.writeMem(this.getDE(),
this.readMem(this.getHL()));this.decDE();this.decHL();this.decBC();0!=this.getBC()?(this.f|=F_PARITY,this.tstates-=5,this.pc--):(this.f&=~F_PARITY,this.pc++);this.f&=~F_NEGATIVE;this.f&=~F_HALFCARRY;break;case 185:b=this.f&F_CARRY|F_NEGATIVE;this.cp_a(this.readMem(this.getHL()));this.decHL();this.decBC();b|=0==this.getBC()?0:F_PARITY;0!=(b&F_PARITY)&&0==(this.f&F_ZERO)?(this.tstates-=5,this.pc--):this.pc++;this.f=this.f&248|b;break;case 186:b=this.port.in_(this.c);this.writeMem(this.getHL(),b);this.b=
this.dec8(this.b);this.decHL();0!=this.b?(this.tstates-=5,this.pc--):this.pc++;this.f=0!=(b&128)?this.f|F_NEGATIVE:this.f&~F_NEGATIVE;break;case 187:b=this.readMem(this.getHL());this.port.out(this.c,b);this.b=this.dec8(this.b);this.decHL();0!=this.b?(this.tstates-=5,this.pc--):this.pc++;255<this.l+b?(this.f|=F_CARRY,this.f|=F_HALFCARRY):(this.f&=~F_CARRY,this.f&=~F_HALFCARRY);this.f=0!=(b&128)?this.f|F_NEGATIVE:this.f&~F_NEGATIVE;break;default:DEBUG&&console.log("Unimplemented ED Opcode: "+a.toString(16)),
this.pc++}},generateDAATable:function(){var a,b,c,d;for(a=256;a--;)for(b=0;1>=b;b++)for(c=0;1>=c;c++)for(d=0;1>=d;d++)this.DAA_TABLE[b<<8|d<<9|c<<10|a]=this.getDAAResult(a,b|d<<1|c<<4);this.a=this.f=0},getDAAResult:function(a,b){this.a=a;this.f=b;var c=this.a,d=0,e=b&F_CARRY,f=e;if(0!=(b&F_HALFCARRY)||9<(c&15))d|=6;if(1==e||159<c||143<c&&9<(c&15))d|=96,f=1;153<c&&(f=1);0!=(b&F_NEGATIVE)?this.sub_a(d):this.add_a(d);b=this.f&254|f;b=this.getParity(this.a)?b&251|F_PARITY:b&251;return this.a|b<<8},add_a:function(a){a=
this.a+a&255;this.f=this.SZHVC_ADD_TABLE[this.a<<8|a];this.a=a},adc_a:function(a){var b=this.f&F_CARRY;a=this.a+a+b&255;this.f=this.SZHVC_ADD_TABLE[b<<16|this.a<<8|a];this.a=a},sub_a:function(a){a=this.a-a&255;this.f=this.SZHVC_SUB_TABLE[this.a<<8|a];this.a=a},sbc_a:function(a){var b=this.f&F_CARRY;a=this.a-a-b&255;this.f=this.SZHVC_SUB_TABLE[b<<16|this.a<<8|a];this.a=a},cp_a:function(a){this.f=this.SZHVC_SUB_TABLE[this.a<<8|this.a-a&255]},cpl_a:function(){this.a^=255;this.f|=F_NEGATIVE|F_HALFCARRY},
rra_a:function(){var a=this.a&1;this.a=(this.a>>1|(this.f&F_CARRY)<<7)&255;this.f=this.f&236|a},rla_a:function(){var a=this.a>>7;this.a=(this.a<<1|this.f&F_CARRY)&255;this.f=this.f&236|a},rlca_a:function(){var a=this.a>>7;this.a=this.a<<1&255|a;this.f=this.f&236|a},rrca_a:function(){var a=this.a&1;this.a=this.a>>1|a<<7;this.f=this.f&236|a},getBC:function(){return this.b<<8|this.c},getDE:function(){return this.d<<8|this.e},getHL:function(){return this.h<<8|this.l},getIX:function(){return this.ixH<<
8|this.ixL},getIY:function(){return this.iyH<<8|this.iyL},setBC:function(a){this.b=a>>8;this.c=a&255},setDE:function(a){this.d=a>>8;this.e=a&255},setHL:function(a){this.h=a>>8;this.l=a&255},setIX:function(a){this.ixH=a>>8;this.ixL=a&255},setIY:function(a){this.iyH=a>>8;this.iyL=a&255},incBC:function(){this.c=this.c+1&255;0==this.c&&(this.b=this.b+1&255)},incDE:function(){this.e=this.e+1&255;0==this.e&&(this.d=this.d+1&255)},incHL:function(){this.l=this.l+1&255;0==this.l&&(this.h=this.h+1&255)},incIX:function(){this.ixL=
this.ixL+1&255;0==this.ixL&&(this.ixH=this.ixH+1&255)},incIY:function(){this.iyL=this.iyL+1&255;0==this.iyL&&(this.iyH=this.iyH+1&255)},decBC:function(){this.c=this.c-1&255;255==this.c&&(this.b=this.b-1&255)},decDE:function(){this.e=this.e-1&255;255==this.e&&(this.d=this.d-1&255)},decHL:function(){this.l=this.l-1&255;255==this.l&&(this.h=this.h-1&255)},decIX:function(){this.ixL=this.ixL-1&255;255==this.ixL&&(this.ixH=this.ixH-1&255)},decIY:function(){this.iyL=this.iyL-1&255;255==this.iyL&&(this.iyH=
this.iyH-1&255)},inc8:function(a){a=a+1&255;this.f=this.f&F_CARRY|this.SZHV_INC_TABLE[a];return a},dec8:function(a){a=a-1&255;this.f=this.f&F_CARRY|this.SZHV_DEC_TABLE[a];return a},exAF:function(){var a=this.a;this.a=this.a2;this.a2=a;a=this.f;this.f=this.f2;this.f2=a},exBC:function(){var a=this.b;this.b=this.b2;this.b2=a;a=this.c;this.c=this.c2;this.c2=a},exDE:function(){var a=this.d;this.d=this.d2;this.d2=a;a=this.e;this.e=this.e2;this.e2=a},exHL:function(){var a=this.h;this.h=this.h2;this.h2=a;
a=this.l;this.l=this.l2;this.l2=a},add16:function(a,b){var c=a+b;this.f=this.f&196|(a^c^b)>>8&16|c>>16&1;return c&65535},adc16:function(a){var b=this.h<<8|this.l,c=b+a+(this.f&F_CARRY);this.f=(b^c^a)>>8&16|c>>16&1|c>>8&128|(0!=(c&65535)?0:64)|((a^b^32768)&(a^c)&32768)>>13;this.h=c>>8&255;this.l=c&255},sbc16:function(a){var b=this.h<<8|this.l,c=b-a-(this.f&F_CARRY);this.f=(b^c^a)>>8&16|2|c>>16&1|c>>8&128|(0!=(c&65535)?0:64)|((a^b)&(b^c)&32768)>>13;this.h=c>>8&255;this.l=c&255},incR:function(){this.r=
this.r&128|this.r+1&127},generateFlagTables:function(){var a,b,c,d,e,f,g;for(a=0;256>a;a++)b=0!=(a&128)?F_SIGN:0,c=0==a?F_ZERO:0,d=a&32,e=a&8,f=this.getParity(a)?F_PARITY:0,this.SZ_TABLE[a]=b|c|d|e,this.SZP_TABLE[a]=b|c|d|e|f,this.SZHV_INC_TABLE[a]=b|c|d|e,this.SZHV_INC_TABLE[a]|=128==a?F_OVERFLOW:0,this.SZHV_INC_TABLE[a]|=0==(a&15)?F_HALFCARRY:0,this.SZHV_DEC_TABLE[a]=b|c|d|e|F_NEGATIVE,this.SZHV_DEC_TABLE[a]|=127==a?F_OVERFLOW:0,this.SZHV_DEC_TABLE[a]|=15==(a&15)?F_HALFCARRY:0,this.SZ_BIT_TABLE[a]=
0!=a?a&128:F_ZERO|F_PARITY,this.SZ_BIT_TABLE[a]|=d|e|F_HALFCARRY;a=0;b=65536;c=0;d=65536;for(f=0;256>f;f++)for(g=0;256>g;g++)e=g-f,this.SZHVC_ADD_TABLE[a]=0!=g?0!=(g&128)?F_SIGN:0:F_ZERO,this.SZHVC_ADD_TABLE[a]|=g&(F_BIT5|F_BIT3),(g&15)<(f&15)&&(this.SZHVC_ADD_TABLE[a]|=F_HALFCARRY),g<f&&(this.SZHVC_ADD_TABLE[a]|=F_CARRY),0!=((e^f^128)&(e^g)&128)&&(this.SZHVC_ADD_TABLE[a]|=F_OVERFLOW),a++,e=g-f-1,this.SZHVC_ADD_TABLE[b]=0!=g?0!=(g&128)?F_SIGN:0:F_ZERO,this.SZHVC_ADD_TABLE[b]|=g&(F_BIT5|F_BIT3),(g&
15)<=(f&15)&&(this.SZHVC_ADD_TABLE[b]|=F_HALFCARRY),g<=f&&(this.SZHVC_ADD_TABLE[b]|=F_CARRY),0!=((e^f^128)&(e^g)&128)&&(this.SZHVC_ADD_TABLE[b]|=F_OVERFLOW),b++,e=f-g,this.SZHVC_SUB_TABLE[c]=0!=g?0!=(g&128)?F_NEGATIVE|F_SIGN:F_NEGATIVE:F_NEGATIVE|F_ZERO,this.SZHVC_SUB_TABLE[c]|=g&(F_BIT5|F_BIT3),(g&15)>(f&15)&&(this.SZHVC_SUB_TABLE[c]|=F_HALFCARRY),g>f&&(this.SZHVC_SUB_TABLE[c]|=F_CARRY),0!=((e^f)&(f^g)&128)&&(this.SZHVC_SUB_TABLE[c]|=F_OVERFLOW),c++,e=f-g-1,this.SZHVC_SUB_TABLE[d]=0!=g?0!=(g&128)?
F_NEGATIVE|F_SIGN:F_NEGATIVE:F_NEGATIVE|F_ZERO,this.SZHVC_SUB_TABLE[d]|=g&(F_BIT5|F_BIT3),(g&15)>=(f&15)&&(this.SZHVC_SUB_TABLE[d]|=F_HALFCARRY),g>=f&&(this.SZHVC_SUB_TABLE[d]|=F_CARRY),0!=((e^f)&(f^g)&128)&&(this.SZHVC_SUB_TABLE[d]|=F_OVERFLOW),d++},getParity:function(a){var b=!0,c;for(c=0;8>c;c++)0!=(a&1<<c)&&(b=!b);return b},getDummyWrite:function(){return JSSMS.Utils.Array(Setup.PAGE_SIZE)},generateMemory:function(){for(var a=0;65>a;a++)this.memReadMap[a]=JSSMS.Utils.Array(Setup.PAGE_SIZE),this.memWriteMap[a]=
JSSMS.Utils.Array(Setup.PAGE_SIZE);for(a=0;8>a;a++)this.ram[a]=JSSMS.Utils.Array(Setup.PAGE_SIZE);null==this.sram&&(this.sram=JSSMS.Utils.Array(32),this.useSRAM=!1);this.memReadMap[64]=this.getDummyWrite();this.memWriteMap[64]=this.getDummyWrite();this.number_of_pages=2},resetMemory:function(a){null!=a&&(this.rom=a);this.frameReg[0]=0;this.frameReg[1]=0;this.frameReg[2]=1;this.frameReg[3]=0;null!=this.rom?(this.number_of_pages=this.rom.length/16,this.setDefaultMemoryMapping()):this.number_of_pages=
0;this.hitCounts=Array(this.number_of_pages*Setup.PAGE_SIZE);for(a=0;a<this.number_of_pages*Setup.PAGE_SIZE;a++)this.hitCounts[a]=0},setDefaultMemoryMapping:function(){for(var a=0;48>a;a++)this.memReadMap[a]=JSSMS.Utils.copyArray(this.rom[a&31]),this.memWriteMap[a]=this.getDummyWrite();for(a=48;64>a;a++)this.memReadMap[a]=this.ram[a&7],this.memWriteMap[a]=this.ram[a&7]},d_:function(){return this.readMem(this.pc)},page:function(a,b){var c,d;this.frameReg[a]=b;switch(a){case 0:if(0!=(b&8)){c=(b&4)<<
2;for(d=32;48>d;d++)this.memReadMap[d]=JSSMS.Utils.copyArray(this.sram[c]),this.memWriteMap[d]=JSSMS.Utils.copyArray(this.sram[c]),c++;this.useSRAM=!0}else{c=this.frameReg[3]%this.number_of_pages<<4;for(d=32;48>d;d++)this.memReadMap[d]=JSSMS.Utils.copyArray(this.rom[c++]),this.memWriteMap[d]=this.getDummyWrite()}break;case 1:c=(b%this.number_of_pages<<4)+1;for(d=1;16>d;d++)this.memReadMap[d]=JSSMS.Utils.copyArray(this.rom[c++]);break;case 2:c=b%this.number_of_pages<<4;for(d=16;32>d;d++)this.memReadMap[d]=
JSSMS.Utils.copyArray(this.rom[c++]);break;case 3:if(0==(this.frameReg[0]&8)){c=b%this.number_of_pages<<4;for(d=32;48>d;d++)this.memReadMap[d]=JSSMS.Utils.copyArray(this.rom[c++])}}},hasUsedSRAM:function(){return this.useSRAM},setSRAM:function(a){var b=a.length/Setup.PAGE_SIZE,c;for(c=0;c<b;c++)JSSMS.Utils.copyArrayElements(a,c*Setup.PAGE_SIZE,this.sram[c],0,Setup.PAGE_SIZE)},setStateMem:function(a){this.frameReg=a;this.setDefaultMemoryMapping();this.page(3,this.frameReg[3]);this.page(2,this.frameReg[2]);
this.page(1,this.frameReg[1]);this.page(0,this.frameReg[0])},getState:function(){var a=Array(8);a[0]=this.pc|this.sp<<16;a[1]=(this.iff1?1:0)|(this.iff2?2:0)|(this.halt?4:0)|(this.EI_inst?8:0)|(this.interruptLine?16:0);a[2]=this.a|this.a2<<8|this.f<<16|this.f2<<24;a[3]=this.getBC()|this.getDE()<<16;a[4]=this.getHL()|this.r<<16|this.i<<24;a[5]=this.getIX()|this.getIY()<<16;this.exBC();this.exDE();this.exHL();a[6]=this.getBC()|this.getDE()<<16;a[7]=this.getHL()|this.im<<16|this.interruptVector<<24;
this.exBC();this.exDE();this.exHL();return a},setState:function(a){var b=a[0];this.pc=b&65535;this.sp=b>>16&65535;b=a[1];this.iff1=0!=(b&1);this.iff2=0!=(b&2);this.halt=0!=(b&4);this.EI_inst=0!=(b&8);this.interruptLine=0!=(b&16);b=a[2];this.a=b&255;this.a2=b>>8&255;this.f=b>>16&255;this.f2=b>>24&255;b=a[3];this.setBC(b&65535);this.setDE(b>>16&65535);b=a[4];this.setHL(b&65535);this.r=b>>16&255;this.i=b>>24&255;b=a[5];this.setIX(b&65535);this.setIY(b>>16&65535);this.exBC();this.exDE();this.exHL();b=
a[6];this.setBC(b&65535);this.setDE(b>>16&65535);b=a[7];this.setHL(b&65535);this.im=b>>16&255;this.interruptVector=b>>24&255;this.exBC();this.exDE();this.exHL()}};var KEY_UP=1,KEY_DOWN=2,KEY_LEFT=4,KEY_RIGHT=8,KEY_FIRE1=16,KEY_FIRE2=32,KEY_START=64;JSSMS.Keyboard=function(a){this.main=a;this.lightgunY=this.lightgunX=this.ggstart=this.controller2=this.controller1=0;this.lightgunEnabled=this.lightgunClick=!1};
JSSMS.Keyboard.prototype={reset:function(){this.ggstart=this.controller2=this.controller1=255;Setup.LIGHTGUN&&(this.lightgunClick=!1);this.pause_button=!1},keydown:function(a){switch(a.keyCode){case 38:this.controller1&=~KEY_UP;break;case 40:this.controller1&=~KEY_DOWN;break;case 37:this.controller1&=~KEY_LEFT;break;case 39:this.controller1&=~KEY_RIGHT;break;case 88:this.controller1&=~KEY_FIRE1;break;case 90:this.controller1&=~KEY_FIRE2;break;case 13:this.main.is_sms?this.main.pause_button=!0:this.ggstart&=
-129;break;case 104:this.controller2&=~KEY_UP;break;case 98:this.controller2&=~KEY_DOWN;break;case 100:this.controller2&=~KEY_LEFT;break;case 102:this.controller2&=~KEY_RIGHT;break;case 103:this.controller2&=~KEY_FIRE1;break;case 105:this.controller2&=~KEY_FIRE2;break;case 97:this.controller2&=~KEY_START;break;default:return}a.preventDefault()},keyup:function(a){switch(a.keyCode){case 38:this.controller1|=KEY_UP;break;case 40:this.controller1|=KEY_DOWN;break;case 37:this.controller1|=KEY_LEFT;break;
case 39:this.controller1|=KEY_RIGHT;break;case 88:this.controller1|=KEY_FIRE1;break;case 90:this.controller1|=KEY_FIRE2;break;case 13:this.main.is_sms||(this.ggstart|=128);break;case 104:this.controller2|=KEY_UP;break;case 98:this.controller2|=KEY_DOWN;break;case 100:this.controller2|=KEY_LEFT;break;case 102:this.controller2|=KEY_RIGHT;break;case 103:this.controller2|=KEY_FIRE1;break;case 105:this.controller2|=KEY_FIRE2;break;case 97:this.controller2|=KEY_START;break;default:return}a.preventDefault()}};var SCALE=8,NO_ANTIALIAS=Number.MIN_VALUE,SHIFT_RESET=32768,FEEDBACK_PATTERN=9,PSG_VOLUME=[25,20,16,13,10,8,6,5,4,3,3,2,2,1,1,0],HI_BOUNDARY=127,LO_BOUNDARY=-128;JSSMS.SN76489=function(a){this.main=a;this.clockFrac=this.clock=0;this.reg=Array(8);this.regLatch=0;this.freqCounter=Array(4);this.freqPolarity=Array(4);this.freqPos=Array(3);this.noiseFreq=16;this.noiseShiftReg=SHIFT_RESET;this.outputChannel=Array(4)};
JSSMS.SN76489.prototype={init:function(a,b){this.clock=(a<<SCALE)/16/b;this.regLatch=this.clockFrac=0;this.noiseFreq=16;this.noiseShiftReg=SHIFT_RESET;for(var c=0;4>c;c++)this.reg[c<<1]=1,this.reg[(c<<1)+1]=15,this.freqCounter[c]=0,this.freqPolarity[c]=1,3!=c&&(this.freqPos[c]=NO_ANTIALIAS)},write:function(a){0!=(a&128)?(this.regLatch=a>>4&7,this.reg[this.regLatch]=this.reg[this.regLatch]&1008|a&15):this.reg[this.regLatch]=0==this.regLatch||2==this.regLatch||4==this.regLatch?this.reg[this.regLatch]&
15|(a&63)<<4:a&15;switch(this.regLatch){case 0:case 2:case 4:0==this.reg[this.regLatch]&&(this.reg[this.regLatch]=1);break;case 6:this.noiseFreq=16<<(this.reg[6]&3),this.noiseShiftReg=SHIFT_RESET}},update:function(a,b){for(var c=[],d=0,e=0;d<b;d++){for(e=0;3>e;e++)this.outputChannel[e]=this.freqPos[e]!=NO_ANTIALIAS?PSG_VOLUME[this.reg[(e<<1)+1]]*this.freqPos[e]>>SCALE:PSG_VOLUME[this.reg[(e<<1)+1]]*this.freqPolarity[e];this.outputChannel[3]=PSG_VOLUME[this.reg[7]]*(this.noiseShiftReg&1)<<1;e=this.outputChannel[0]+
this.outputChannel[1]+this.outputChannel[2]+this.outputChannel[3];e>HI_BOUNDARY?e=HI_BOUNDARY:e<LO_BOUNDARY&&(e=LO_BOUNDARY);c[a+d]=e;this.clockFrac+=this.clock;var f=this.clockFrac>>SCALE,g=f<<SCALE;this.clockFrac-=g;this.freqCounter[0]-=f;this.freqCounter[1]-=f;this.freqCounter[2]-=f;this.freqCounter[3]=128==this.noiseFreq?this.freqCounter[2]:this.freqCounter[3]-f;for(e=0;3>e;e++){var l=this.freqCounter[e];if(0>=l){var m=this.reg[e<<1];6<m?(this.freqPos[e]=(g-this.clockFrac+(2<<SCALE)*l<<SCALE)*
this.freqPolarity[e]/(g+this.clockFrac),this.freqPolarity[e]=-this.freqPolarity[e]):(this.freqPolarity[e]=1,this.freqPos[e]=NO_ANTIALIAS);this.freqCounter[e]+=m*(f/m+1)}else this.freqPos[e]=NO_ANTIALIAS}0>=this.freqCounter[3]&&(this.freqPolarity[3]=-this.freqPolarity[3],128!=this.noiseFreq&&(this.freqCounter[3]+=this.noiseFreq*(f/this.noiseFreq+1)),1==this.freqPolarity[3]&&(e=0,e=0!=(this.reg[6]&4)?0!=(this.noiseShiftReg&FEEDBACK_PATTERN)&&0!=(this.noiseShiftReg&FEEDBACK_PATTERN^FEEDBACK_PATTERN)?
1:0:this.noiseShiftReg&1,this.noiseShiftReg=this.noiseShiftReg>>1|e<<15))}return c}};var NTSC=0,PAL=1,SMS_X_PIXELS=342,SMS_Y_PIXELS_NTSC=262,SMS_Y_PIXELS_PAL=313,SMS_WIDTH=256,SMS_HEIGHT=192,GG_WIDTH=160,GG_HEIGHT=144,GG_X_OFFSET=48,GG_Y_OFFSET=24,STATUS_VINT=128,STATUS_OVERFLOW=64,STATUS_COLLISION=32,STATUS_HINT=4,BGT_LENGTH=1792,SPRITES_PER_LINE=8,SPRITE_COUNT=0,SPRITE_X=1,SPRITE_Y=2,SPRITE_N=3,TOTAL_TILES=512,TILE_SIZE=8;
JSSMS.Vdp=function(a){this.main=a;var b;this.videoMode=NTSC;this.VRAM=Array(16384);this.CRAM=Array(96);for(b=0;96>b;b++)this.CRAM[b]=255;this.vdpreg=Array(16);this.status=0;this.firstByte=!1;this.counter=this.line=this.readBuffer=this.operation=this.location=this.commandByte=0;this.bgPriority=Array(SMS_WIDTH);Setup.VDP_SPRITE_COLLISIONS&&(this.spriteCol=Array(SMS_WIDTH));this.vScrollLatch=this.bgt=0;this.display=a.ui.canvasImageData.data;this.main_JAVA=Array(64);this.GG_JAVA1=Array(256);this.GG_JAVA2=
Array(16);this.isPalConverted=!1;this.sat=this.h_end=this.h_start=0;this.isSatDirty=!1;this.lineSprites=Array(SMS_HEIGHT);for(b=0;b<SMS_HEIGHT;b++)this.lineSprites[b]=Array(1+3*SPRITES_PER_LINE);this.tiles=Array(TOTAL_TILES);this.isTileDirty=Array(TOTAL_TILES);this.maxDirty=this.minDirty=0;this.createCachedImages()};
JSSMS.Vdp.prototype={reset:function(){var a;this.isPalConverted=!1;this.generateConvertedPals();this.firstByte=!0;for(a=this.operation=this.status=this.counter=this.location=0;16>a;a++)this.vdpreg[a]=0;this.vdpreg[2]=14;this.vdpreg[5]=126;this.vScrollLatch=0;this.main.cpu.interruptLine=!1;this.isSatDirty=!0;this.minDirty=TOTAL_TILES;this.maxDirty=-1;for(a=0;16384>a;a++)this.VRAM[a]=0;for(a=0;a<4*SMS_WIDTH*SMS_HEIGHT;a+=4)this.display[a]=0,this.display[a+1]=0,this.display[a+2]=0,this.display[a+3]=
255},forceFullRedraw:function(){this.bgt=(this.vdpreg[2]&14)<<10;this.minDirty=0;this.maxDirty=TOTAL_TILES-1;for(var a=0,b=this.isTileDirty.length;a<b;a++)this.isTileDirty[a]=!0;this.sat=(this.vdpreg[5]&-130)<<7;this.isSatDirty=!0},getVCount:function(){if(this.videoMode==NTSC){if(218<this.line)return this.line-6}else if(242<this.line)return this.line-57;return this.line},controlRead:function(){this.firstByte=!0;var a=this.status;this.status=0;this.main.cpu.interruptLine=!1;return a},controlWrite:function(a){if(this.firstByte)this.firstByte=
!1,this.commandByte=a,this.location=this.location&16128|a;else if(this.firstByte=!0,this.operation=a>>6&3,this.location=this.commandByte|a<<8,0==this.operation)this.readBuffer=this.VRAM[this.location++&16383]&255;else if(2==this.operation){a&=15;switch(a){case 0:Setup.ACCURATE_INTERRUPT_EMULATION&&0!=(this.status&STATUS_HINT)&&(this.main.cpu.interruptLine=0!=(this.commandByte&16));break;case 1:0!=(this.status&STATUS_VINT)&&0!=(this.commandByte&32)&&(this.main.cpu.interruptLine=!0);(this.commandByte&
3)!=(this.vdpreg[a]&3)&&(this.isSatDirty=!0);break;case 2:this.bgt=(this.commandByte&14)<<10;break;case 5:var b=this.sat;this.sat=(this.commandByte&-130)<<7;b!=this.sat&&(this.isSatDirty=!0,DEBUG&&console.log("New address written to SAT: "+b+" -> "+this.sat))}this.vdpreg[a]=this.commandByte}},dataRead:function(){this.firstByte=!0;var a=this.readBuffer;this.readBuffer=this.VRAM[this.location++&16383]&255;return a},dataWrite:function(a){var b=0;this.firstByte=!0;switch(this.operation){case 0:case 1:case 2:b=
this.location&16383;if(a!=(this.VRAM[b]&255)){if(b>=this.sat&&b<this.sat+64)this.isSatDirty=!0;else if(b>=this.sat+128&&b<this.sat+256)this.isSatDirty=!0;else{var c=b>>5;this.isTileDirty[c]=!0;c<this.minDirty&&(this.minDirty=c);c>this.maxDirty&&(this.maxDirty=c)}this.VRAM[b]=a}break;case 3:this.main.is_sms?(b=3*(this.location&31),this.CRAM[b]=this.main_JAVA[a&63]&255,this.CRAM[b+1]=this.main_JAVA[a&63]>>8&255,this.CRAM[b+2]=this.main_JAVA[a&63]>>16&255):this.main.is_gg&&(b=3*((this.location&63)>>
1),0==(this.location&1)?(this.CRAM[b]=this.GG_JAVA1[a]&255,this.CRAM[b+1]=this.GG_JAVA1[a]>>8&255):this.CRAM[b+2]=this.GG_JAVA2[a&15]>>16&255)}ACCURATE&&(this.readBuffer=a);this.location++},interrupts:function(a){192>=a?(!Setup.ACCURATE_INTERRUPT_EMULATION&&192==a&&(this.status|=STATUS_VINT),0==this.counter?(this.counter=this.vdpreg[10],this.status|=STATUS_HINT):this.counter--,0!=(this.status&STATUS_HINT)&&0!=(this.vdpreg[0]&16)&&(this.main.cpu.interruptLine=!0)):(this.counter=this.vdpreg[10],0!=
(this.status&STATUS_VINT)&&(0!=(this.vdpreg[1]&32)&&224>a)&&(this.main.cpu.interruptLine=!0),ACCURATE&&a==this.main.no_of_scanlines-1&&(this.vScrollLatch=this.vdpreg[9]))},setVBlankFlag:function(){this.status|=STATUS_VINT},drawLine:function(a){var b=0,c=0,d=0;if(!this.main.is_gg||!(a<GG_Y_OFFSET||a>=GG_Y_OFFSET+GG_HEIGHT)){if(Setup.VDP_SPRITE_COLLISIONS)for(b=SMS_WIDTH;b--;)this.spriteCol[b]=!1;if(0!=(this.vdpreg[1]&64)){if(-1!=this.maxDirty&&this.decodeTiles(),this.drawBg(a),this.isSatDirty&&this.decodeSat(),
0!=this.lineSprites[a][SPRITE_COUNT]&&this.drawSprite(a),this.main.is_sms&&0!=(this.vdpreg[0]&32)){a<<=8;if(32<16+(this.vdpreg[7]&15))debugger;if(a>SMS_WIDTH*SMS_HEIGHT)debugger;c=4*a;d=3*(16+(this.vdpreg[7]&15));for(b=0;8>b;b++)this.display[c+b]=this.CRAM[d],this.display[c+b+1]=this.CRAM[d],this.display[c+b+2]=this.CRAM[d]}}else this.drawBGColour(a)}},drawBg:function(a){var b=0,c=0,d=0,e=0,f=this.vdpreg[8],g=ACCURATE?this.vScrollLatch:this.vdpreg[9];16>a&&0!=(this.vdpreg[0]&64)&&(f=0);var l=this.vdpreg[0]&
128,m=32-(f>>3)+this.h_start,j=a+g>>3;27<j&&(j-=28);for(var g=(a+(g&7)&7)<<3,k=a<<8,h=this.h_start;h<this.h_end;h++){var b=this.bgt+((m&31)<<1)+(j<<6),n=this.VRAM[b+1],q=(n&8)<<1,p=(h<<3)+(f&7),r=0==(n&4)?g:56-g,s=this.tiles[(this.VRAM[b]&255)+((n&1)<<8)];if(0==(n&2))for(b=0;8>b&&p<SMS_WIDTH;b++,p++)c=s[b+r],d=4*(p+k),e=3*(c+q),this.bgPriority[p]=0!=(n&16)&&0!=c,this.display[d]=this.CRAM[e],this.display[d+1]=this.CRAM[e+1],this.display[d+2]=this.CRAM[e+2];else for(b=7;0<=b&&p<SMS_WIDTH;b--,p++)c=
s[b+r],d=4*(p+k),e=3*(c+q),this.bgPriority[p]=0!=(n&16)&&0!=c,this.display[d]=this.CRAM[e],this.display[d+1]=this.CRAM[e+1],this.display[d+2]=this.CRAM[e+2];m++;0!=l&&23==h&&(j=a>>3,g=(a&7)<<3)}},drawSprite:function(a){for(var b=0,c=0,d=0,e=this.lineSprites[a],f=Math.min(SPRITES_PER_LINE,e[SPRITE_COUNT]),g=this.vdpreg[1]&1,l=a<<8,m=3*f;f--;){var j=e[m--]|(this.vdpreg[6]&4)<<6,k=e[m--],h=e[m--]-(this.vdpreg[0]&8),b=a-k>>g;0!=(this.vdpreg[1]&2)&&(j&=-2);j=this.tiles[j+((b&8)>>3)];k=0;0>h&&(k=-h,h=0);
var n=k+((b&7)<<3);if(0==g)for(;8>k&&h<SMS_WIDTH;k++,h++)b=j[n++],0!=b&&!this.bgPriority[h]&&(c=4*(h+l),d=3*(b+16),this.display[c]=this.CRAM[d],this.display[c+1]=this.CRAM[d+1],this.display[c+2]=this.CRAM[d+2],Setup.VDP_SPRITE_COLLISIONS&&(this.spriteCol[h]?this.status|=STATUS_COLLISION:this.spriteCol[h]=!0));else for(;8>k&&h<SMS_WIDTH;k++,h+=2)b=j[n++],0!=b&&!this.bgPriority[h]&&(c=4*(h+l),d=3*(b+16),this.display[c]=this.CRAM[d],this.display[c+1]=this.CRAM[d+1],this.display[c+2]=this.CRAM[d+2],Setup.VDP_SPRITE_COLLISIONS&&
(this.spriteCol[h]?this.status|=STATUS_COLLISION:this.spriteCol[h]=!0)),0!=b&&!this.bgPriority[h+1]&&(c=4*(h+l+1),d=3*(b+16),this.display[c]=this.CRAM[d],this.display[c+1]=this.CRAM[d+1],this.display[c+2]=this.CRAM[d+2],Setup.VDP_SPRITE_COLLISIONS&&(this.spriteCol[h+1]?this.status|=STATUS_COLLISION:this.spriteCol[h+1]=!0))}e[SPRITE_COUNT]>=SPRITES_PER_LINE&&(this.status|=STATUS_OVERFLOW)},drawBGColour:function(a){a<<=8;for(var b=0,c=3*(16+(this.vdpreg[7]&15)),d=0;d<4*SMS_WIDTH;d++)b=4*a,this.display[b]=
this.CRAM[c],this.display[b+1]=this.CRAM[c+1],this.display[b+2]=this.CRAM[c+2],a++},generateConvertedPals:function(){var a,b,c,d;if(this.main.is_sms&&!this.isPalConverted)for(a=0;64>a;a++)b=a&3,c=a>>2&3,d=a>>4&3,this.main_JAVA[a]=85*b|85*c<<8|85*d<<16,this.isPalConverted=!0;else if(this.main.is_gg&&!this.isPalConverted){for(a=0;256>a;a++)c=a&15,d=a>>4&15,this.GG_JAVA1[a]=d<<12|d<<8|c<<4|c;for(a=0;16>a;a++)this.GG_JAVA2[a]=a<<20;this.isPalConverted=!0}},createCachedImages:function(){for(var a=0;a<
TOTAL_TILES;a++)this.tiles[a]=Array(TILE_SIZE*TILE_SIZE)},decodeTiles:function(){DEBUG&&console.log("["+this.line+"] min dirty:"+this.minDirty+" max: "+this.maxDirty);for(var a=this.minDirty;a<=this.maxDirty;a++)if(this.isTileDirty[a]){this.isTileDirty[a]=!1;DEBUG&&console.log("tile "+a+" is dirty");for(var b=this.tiles[a],c=0,d=a<<5,e=0;e<TILE_SIZE;e++)for(var f=this.VRAM[d++],g=this.VRAM[d++],l=this.VRAM[d++],m=this.VRAM[d++],j=128;0!=j;j>>=1){var k=0;0!=(f&j)&&(k|=1);0!=(g&j)&&(k|=2);0!=(l&j)&&
(k|=4);0!=(m&j)&&(k|=8);b[c++]=k}}this.minDirty=TOTAL_TILES;this.maxDirty=-1},decodeSat:function(){this.isSatDirty=!1;for(var a=0;a<this.lineSprites.length;a++)this.lineSprites[a][SPRITE_COUNT]=0;a=0==(this.vdpreg[1]&2)?8:16;1==(this.vdpreg[1]&1)&&(a<<=1);for(var b=0;64>b;b++){var c=this.VRAM[this.sat+b]&255;if(208==c)break;c++;240<c&&(c-=256);for(var d=0;d<SMS_HEIGHT;d++)if(d>=c&&d-c<a){var e=this.lineSprites[d];if(e[SPRITE_COUNT]<SPRITES_PER_LINE){var f=3*e[SPRITE_COUNT]+SPRITE_X,g=this.sat+(b<<
1)+128;e[f++]=this.VRAM[g++]&255;e[f++]=c;e[f++]=this.VRAM[g]&255;e[SPRITE_COUNT]++}}}},getState:function(){var a=Array(51);a[0]=this.videoMode|this.status<<8|(this.firstByte?65536:0)|this.commandByte<<24;a[1]=this.location|this.operation<<16|this.readBuffer<<24;a[2]=this.counter|this.vScrollLatch<<8|this.line<<16;JSSMS.Utils.copyArrayElements(this.vdpreg,0,a,3,16);JSSMS.Utils.copyArrayElements(this.CRAM,0,a,19,96);return a},setState:function(a){var b=a[0];this.videoMode=b&255;this.status=b>>8&255;
this.firstByte=0!=(b>>16&255);this.commandByte=b>>24&255;b=a[1];this.location=b&65535;this.operation=b>>16&255;this.readBuffer=b>>24&255;b=a[2];this.counter=b&255;this.vScrollLatch=b>>8&255;this.line=b>>16&65535;JSSMS.Utils.copyArrayElements(a,3,this.vdpreg,0,16);JSSMS.Utils.copyArrayElements(a,19,this.CRAM,0,96);this.forceFullRedraw()}};JSSMS.DummyUI=function(a){this.main=a;this.enable=function(){};this.updateStatus=function(){};this.writeAudio=function(){};this.writeFrame=function(){}};
"undefined"!=typeof $&&($.fn.JSSMSUI=function(a){var b=this,c=function(c){this.main=c;if("[object OperaMini]"==Object.prototype.toString.call(window.operamini))$(b).html('<div class="alert alert-error"><strong>Oh no!</strong> Your browser can\'t run this emulator. Try the latest version of Firefox, Google Chrome, Opera or Safari!</div>');else{var e=this;c=$("<div></div>");var f=$('<div class="controls"></div>'),g=JSSMS.Utils.getPrefix(["fullscreenEnabled","mozFullScreenEnabled","webkitCancelFullScreen"]),
l=JSSMS.Utils.getPrefix(["requestAnimationFrame","msRequestAnimationFrame","mozRequestAnimationFrame","webkitRequestAnimationFrame","oRequestAnimationFrame"],window),m;if(l)this.requestAnimationFrame=window[l].bind(window);else{var j=0;this.requestAnimationFrame=function(a){var b=JSSMS.Utils.getTimestamp(),c=Math.max(0,16-(b-j));window.setTimeout(function(){a(b+c)},c);j=b+c}}this.zoomed=!1;this.hiddenPrefix=JSSMS.Utils.getPrefix(["hidden","mozHidden","webkitHidden","msHidden"]);this.screen=$("<canvas width="+
SMS_WIDTH+" height="+SMS_HEIGHT+' class="screen"></canvas>');this.canvasContext=this.screen[0].getContext("2d");if(this.canvasContext.getImageData){this.canvasImageData=this.canvasContext.getImageData(0,0,SMS_WIDTH,SMS_HEIGHT);this.romContainer=$("<div></div>");this.romSelect=$("<select></select>");this.romSelect.change(function(){e.loadROM()});this.buttons={start:$('<input type="button" value="Stop" class="btn" disabled="disabled">'),restart:$('<input type="button" value="Restart" class="btn" disabled="disabled">'),
sound:$('<input type="button" value="Enable sound" class="btn" disabled="disabled">'),zoom:$('<input type="button" value="Zoom in" class="btn hidden-phone">')};this.buttons.start.click(function(){e.main.isRunning?(e.main.stop(),e.updateStatus("Paused"),e.buttons.start.attr("value","Start")):(e.main.start(),e.buttons.start.attr("value","Stop"))});this.buttons.restart.click(function(){e.main.reloadRom()?(e.main.reset(),e.main.vdp.forceFullRedraw(),e.main.start()):$(this).attr("disabled","disabled")});
this.buttons.sound.click(function(){});this.buttons.zoom.click(function(){e.zoomed?(e.screen.animate({width:SMS_WIDTH+"px",height:SMS_HEIGHT+"px"},function(){$(this).removeAttr("style")}),e.buttons.zoom.attr("value","Zoom in")):(e.screen.animate({width:2*SMS_WIDTH+"px",height:2*SMS_HEIGHT+"px"}),e.buttons.zoom.attr("value","Zoom out"));e.zoomed=!e.zoomed});g&&(this.buttons.fullsreen=$('<input type="button" value="Go fullscreen" class="btn">').click(function(){var a=e.screen[0];a.requestFullscreen?
a.requestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}));for(m in this.buttons)this.buttons.hasOwnProperty(m)&&this.buttons[m].appendTo(f);this.log=$('<div id="status"></div>');this.screen.appendTo(c);this.romContainer.appendTo(c);f.appendTo(c);this.log.appendTo(c);c.appendTo($(b));void 0!=a&&this.setRoms(a);$(document).bind("keydown",function(a){e.main.keyboard.keydown(a)}).bind("keyup",function(a){e.main.keyboard.keyup(a)})}else $(b).html('<div class="alert alert-error"><strong>Oh no!</strong> Your browser doesn\'t support writing pixels directly to the <code>&lt;canvas&gt;</code> tag. Try the latest version of Firefox, Google Chrome, Opera or Safari!</div>')}};
c.prototype={reset:function(){this.screen[0].width=SMS_WIDTH;this.screen[0].height=SMS_HEIGHT;this.log.text("")},setRoms:function(a){var b,c,g,l,m=0;this.romSelect.children().remove();$("<option>Select a ROM...</option>").appendTo(this.romSelect);for(b in a){if(a.hasOwnProperty(b)){c=$("<optgroup></optgroup>").attr("label",b);g=a[b].length;for(l=0;l<g;l++)$("<option>"+a[b][l][0]+"</option>").attr("value",a[b][l][1]).appendTo(c);c.appendTo(this.romSelect)}m++}m&&this.romSelect.appendTo(this.romContainer)},
loadROM:function(){var a=this;this.updateStatus("Downloading...");$.ajax({url:escape(this.romSelect.val()),xhr:function(){var b=$.ajaxSettings.xhr();void 0!=b.overrideMimeType&&b.overrideMimeType("text/plain; charset=x-user-defined");return a.xhr=b},complete:function(b,c){var g;"error"==c?a.updateStatus("The selected rom could not be loaded."):(g=b.responseText,a.main.readRomDirectly(g,a.romSelect.val()),a.main.reset(),a.main.vdp.forceFullRedraw(),a.main.start(),a.enable(),a.buttons.start.removeAttr("disabled"))}})},
enable:function(){this.buttons.restart.removeAttr("disabled");this.main.soundEnabled?this.buttons.sound.attr("value","Disable sound"):this.buttons.sound.attr("value","Enable sound")},updateStatus:function(a){this.log.text(a)},writeAudio:function(){},writeFrame:function(){(!this.hiddenPrefix||!document[this.hiddenPrefix])&&this.canvasContext.putImageData(this.canvasImageData,0,0)}};return c});var IO_TR_DIRECTION=0,IO_TH_DIRECTION=1,IO_TR_OUTPUT=2,IO_TH_OUTPUT=3,IO_TH_INPUT=4,PORT_A=0,PORT_B=5;JSSMS.Ports=function(a){this.main=a;this.vdp=a.vdp;this.psg=a.psg;this.keyboard=a.keyboard;this.europe=64;this.hCounter=0;this.ioPorts=[]};
JSSMS.Ports.prototype={reset:function(){Setup.LIGHTGUN?(this.ioPorts=Array(10),this.ioPorts[PORT_A+IO_TH_INPUT]=1,this.ioPorts[PORT_B+IO_TH_INPUT]=1):this.ioPorts=Array(2)},out:function(a,b){if(!(this.main.is_gg&&7>a))switch(a&193){case 1:if(Setup.LIGHTGUN){if(this.oldTH=0!=this.getTH(PORT_A)||0!=this.getTH(PORT_B),this.writePort(PORT_A,b),this.writePort(PORT_B,b>>2),!this.oldTH&&(0!=this.getTH(PORT_A)||0!=this.getTH(PORT_B)))this.hCounter=this.getHCount()}else this.ioPorts[0]=(b&32)<<1,this.ioPorts[1]=
b&128,0==this.europe&&(this.ioPorts[0]=~this.ioPorts[0],this.ioPorts[1]=~this.ioPorts[1]);break;case 128:this.vdp.dataWrite(b);break;case 129:this.vdp.controlWrite(b);break;case 64:case 65:this.main.soundEnabled&&this.psg.write(b)}},in_:function(a){if(this.main.is_gg&&7>a)switch(a){case 0:return this.keyboard.ggstart&191|this.europe;case 1:case 2:case 3:case 4:case 5:return 0;case 6:return 255}switch(a&193){case 64:return this.vdp.getVCount();case 65:return this.hCounter;case 128:return this.vdp.dataRead();
case 129:return this.vdp.controlRead();case 192:return this.keyboard.controller1;case 193:return Setup.LIGHTGUN?(this.keyboard.lightgunClick&&this.lightPhaserSync(),this.keyboard.controller2&63|(0!=this.getTH(PORT_A)?64:0)|(0!=this.getTH(PORT_B)?128:0)):this.keyboard.controller2&63|this.ioPorts[0]|this.ioPorts[1]}return 255},writePort:function(a,b){this.ioPorts[a+IO_TR_DIRECTION]=b&1;this.ioPorts[a+IO_TH_DIRECTION]=b&2;this.ioPorts[a+IO_TR_OUTPUT]=b&16;this.ioPorts[a+IO_TH_OUTPUT]=0==this.europe?
~b&32:b&32},getTH:function(a){return 0==this.ioPorts[a+IO_TH_DIRECTION]?this.ioPorts[a+IO_TH_OUTPUT]:this.ioPorts[a+IO_TH_INPUT]},setTH:function(a,b){this.ioPorts[a+IO_TH_DIRECTION]=1;this.ioPorts[a+IO_TH_INPUT]=b?1:0},getHCount:function(){var a=Math.round(this.main.cpu.getCycle()*SMS_X_PIXELS/this.main.cyclesPerLine)-8>>1;147<a&&(a+=85);return a&255},X_RANGE:48,Y_RANGE:4,lightPhaserSync:function(){var a=this.getTH(PORT_A),b=this.getHCount(),c=this.keyboard.lightgunX-(b<<1),d=this.keyboard.lightgunY-
this.vdp.line;d>-this.Y_RANGE&&d<this.Y_RANGE&&c>-this.X_RANGE&&c<this.X_RANGE?(this.setTH(PORT_A,!1),a!=this.getTH(PORT_A)&&(this.hCounter=20+(this.keyboard.lightgunX>>1))):(this.setTH(PORT_A,!0),a!=this.getTH(PORT_A)&&(this.hCounter=b))},setDomestic:function(a){this.europe=a?64:0},isDomestic:function(){return 0!=this.europe}};window.JSSMS=JSSMS;jQuery.fn.JSSMSUI=jQuery.fn.JSSMSUI;
